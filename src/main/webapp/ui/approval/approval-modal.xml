<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
        	<w2:dataCollection baseNode="map">
        		<w2:dataList baseNode="list" repeatNode="map" id="dl_manager" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column dataType="text" name="empNo" id="empNo"></w2:column>
        				<w2:column dataType="text" name="empName" id="empName"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dm_approvalReq">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="claim_no" id="claim_no"></w2:key>
        				<w2:key dataType="text" name="emp_no" id="emp_no"></w2:key>
        				<w2:key dataType="text" name="manager_no" id="manager_no"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_deptName">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="dept_name" id="dept_name"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_claim">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="claim_no" id="claim_no"></w2:key>
        				<w2:key dataType="text" name="status" id="status"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection />
        	<xf:submission id="sbm_insertApprovalReq" action="/InsWebApp/APPROVALREQIns.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_approvalReq","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_insertApprovalReq_submitdone"
        		ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getManager" action="/InsWebApp/EmployeeForRule.pwkjson" method="post" mediatype="application/json" ref=""
        		target='data:json,{"id":"dl_manager","key":"employeeVoList"}' encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getManager_submitdone" ev:submiterror=""
        		abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getDeptName" action="/InsWebApp/insdept0001UpdView.pwkjson" method="post" mediatype="application/json"
        		ref="" target='data:json,{"id":"dm_deptName","key":"elData"}' encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="로딩중.." ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_updateClaim" action="/InsWebApp/CLAIMUpd.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_claim","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_updateClaim_submitdone" ev:submiterror=""
        		abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_insertMemo" action="/InsWebApp/CLAIMRESULTIns.pwkjson" method="post" mediatype="application/json" ref=""
        		target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_deleteResult" action="/InsWebApp/CLAIMRESULTDel.pwkjson" method="post" mediatype="application/json"
        		ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg=""
        		ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        <script lazy="false" type="text/javascript"><![CDATA[scwin.onpageload = function() {
    scwin.emp = JSON.parse(localStorage.getItem("employee"));
    scwin.claim = JSON.parse(localStorage.getItem("claim"));
	ipt_claimNo.setValue(scwin.claim.claimNo);
    ipt_emp.setValue(scwin.emp.empName);

    dm_claim.set("claim_no", scwin.claim.claimNo);

    $c.sbm.execute(sbm_getDeptName, {"elData": {"dept_id": scwin.emp.deptId}});

    $c.sbm.execute(sbm_getManager, {"elData": {"deptId": scwin.emp.deptId, "role": "관리자"}});
};

scwin.sbm_getManager_submitdone = function (e) {
    select_manager.setSelectedIndex(0);
};

scwin.btn_close_onclick = function (e) {
    // 닫기
    $p.closePopup();
};

scwin.btn_confirm_onclick = function (e) {
    dm_approvalReq.set("emp_no", scwin.emp.empNo);
    $c.sbm.execute(sbm_insertApprovalReq);    
};

scwin.sbm_updateClaim_submitdone = function (e) {
    $p.closePopup();
};


scwin.sbm_insertApprovalReq_submitdone = function (e) {
    
    dm_claim.set("status", "결재중");
    // console.log(dm_claim.getJSON());
    $c.sbm.execute(sbm_updateClaim);

    let memo = $p.parent().txt_examMemo.getValue();
    $c.sbm.execute(sbm_deleteResult, {"elData" : {claim_no: scwin.claim.claimNo}});
    $c.sbm.execute(sbm_insertMemo, {"elData" : {claim_memo: memo, claim_no: scwin.claim.claimNo}});

    Swal.fire({
		title: '결재 신청이 완료되었습니다.',
		timer: 5000,
		showConfirmButton: false,
	});

    setTimeout(function() {
        location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/webWrapper.xml";
    }, 2000);
};
]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">
    	<xf:group class="sub_contents" id="" meta_snippetCategory="00_화면시작" meta_snippetKeyComponent="true" meta_snippetName="0_01 페이지시작"
    		style="">
    		<xf:group style="" id="">
    			<w2:textbox style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;" label="청구 번호"></w2:textbox>
    			<xf:input class="" id="ipt_claimNo" meta_snippetCategory="10_입력폼" meta_snippetKeyComponent="true"
    				meta_snippetName="10_01 InputBox" placeholder="" style="width: 100%;" readOnly="true" ref="data:dm_approvalReq.claim_no">
    			</xf:input>
    		</xf:group>
    		<xf:group style="margin-top: 20px;" id="">
    			<w2:textbox style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;" label="현재 담당자" ref=""></w2:textbox>
    			<xf:input meta_snippetCategory="10_입력폼" meta_snippetName="10_01 InputBox" meta_snippetKeyComponent="true" style="width: 100%;"
    				id="ipt_emp" placeholder="" class="" readOnly="true">
    			</xf:input>
    		</xf:group>
    		<xf:group id="" style="margin-top: 20px;display: flex;gap: 15px;">
    			<xf:group style="flex: 1;">
    				<w2:textbox label="부서" style="display: block; margin-bottom: 5px;  font-weight: bold; color: #555;"></w2:textbox>
    				<xf:input class="" id="ipt_dept" meta_snippetCategory="10_입력폼" meta_snippetKeyComponent="true"
    					meta_snippetName="10_07 Inputbox_100per" placeholder="" style="width:100%;" readOnly="true" ref="data:dm_deptName.dept_name">
    				</xf:input>
    			</xf:group>
    			<xf:group style="flex: 1;">
    				<w2:textbox label="담당자" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;"></w2:textbox>
    				<xf:select1 allOption="" appearance="minimal" chooseOption="" chooseOptionLabel="선택" class="" direction="auto"
    					disabled="false" disabledClass="w2selectbox_disabled" id="select_manager" ref="data:dm_approvalReq.manager_no" renderType=""
    					style="width: 100%;" submenuSize="auto">
    					<xf:choices>
    						<xf:itemset nodeset="data:dl_manager">
    							<xf:label ref="empName"></xf:label>
    							<xf:value ref="empNo"></xf:value>
    						</xf:itemset>
    					</xf:choices>
    				</xf:select1>
    			</xf:group>
    		</xf:group>
    		<xf:group class="btnbox" id="" meta_snippetCategory="08_버튼" meta_snippetKeyComponent="true" meta_snippetName="8_05 팝업전체제어버튼"
    			style="margin-top: 20px;">
    			<xf:group class="rt" id="" style="">
    				<xf:trigger class="btn_cm " ev:onclick="scwin.btn_close_onclick" id="trigger3" style="" type="button">
    					<xf:label><![CDATA[닫기]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn_cm pt" ev:onclick="scwin.btn_confirm_onclick" id="trigger4" style="" type="button">
    					<xf:label><![CDATA[확인]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    	</xf:group>
    </body>
</html>
