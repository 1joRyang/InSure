<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
        	<w2:dataCollection baseNode="map">
        		<w2:dataMap baseNode="map" id="dma_claimNo">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="claim_no" id="claim_no"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dma_returnReq">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="claim_no" id="claim_no"></w2:key>
        				<w2:key dataType="text" name="return_memo" id="return_memo"></w2:key>
        				<w2:key dataType="text" name="request_date" id="request_date"></w2:key>
        				<w2:key dataType="text" name="completed_date" id="completed_date"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection />
        	
        	<!-- 존재 여부 확인 submission -->
        	<xf:submission id="sbm_checkReturnReq" action="/InsWebApp/RETURNREQCheck.pwkjson" method="post"
        		mediatype="application/json" ref='data:json,{"id":"dma_claimNo","key":"returnReqVo"}' 
        		target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="확인중입니다..." 
        		ev:submit="" ev:submitdone="scwin.sbm_checkReturnReq_submitdone" 
        		ev:submiterror="scwin.sbm_checkReturnReq_submiterror" abortTrigger="">
        	</xf:submission>
        	
        	<!-- INSERT 전용 submission -->
        	<xf:submission id="sbm_insertReturnReq" action="/InsWebApp/RETURNREQInsertOnly.pwkjson" method="post"
        		mediatype="application/json" ref='data:json,{"id":"dma_returnReq","key":"returnReqVo"}' 
        		target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="등록중입니다..." 
        		ev:submit="" ev:submitdone="scwin.sbm_insertReturnReq_submitdone" 
        		ev:submiterror="scwin.sbm_insertReturnReq_submiterror" abortTrigger="">
        	</xf:submission>
        	
        	<!-- UPDATE 전용 submission -->
        	<xf:submission id="sbm_updateReturnReq" action="/InsWebApp/RETURNREQUpdateOnly.pwkjson" method="post"
        		mediatype="application/json" ref='data:json,{"id":"dma_returnReq","key":"returnReqVo"}' 
        		target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="수정중입니다..." 
        		ev:submit="" ev:submitdone="scwin.sbm_updateReturnReq_submitdone" 
        		ev:submiterror="scwin.sbm_updateReturnReq_submiterror" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        <script lazy="false" type="text/javascript"><![CDATA[

scwin.onpageload = function () {
    scwin.claim = JSON.parse(localStorage.getItem("claim"));

    txt_claim_no.setValue(scwin.claim.claimNo);
    dma_returnReq.set("claim_no", scwin.claim.claimNo);
    dma_claimNo.set("claim_no", scwin.claim.claimNo);
};

scwin.btn_submit_onclick = function (e) {
    // textarea 값 검증
    var returnMemo = txa_additional_memo.getValue();
    if (!returnMemo || returnMemo.trim() === "") {
        $p.closePopup();
        scwin.toastAlert({
            icon: 'warning',
            title: '반송 사유를 입력해주세요.'
        });
        txa_additional_memo.focus();
        return false;
    }

    scwin.twoBtnAlert({
        title: '반송 처리하시겠습니까?',
        text: '반송 처리 후에는 취소할 수 없습니다.',
        icon: 'question'
    }, (result) => {
        if (result.isConfirmed) {
            dma_returnReq.set("return_memo", returnMemo.trim());

            console.log("존재 여부 확인 중...");
            console.log("CLAIM_NO:", dma_claimNo.get("claim_no"));

            $p.executeSubmission("sbm_checkReturnReq");
        }
    });
};

scwin.btn_close_onclick = function (e) {
    $p.closePopup();
    return true;
};


scwin.sbm_checkReturnReq_submitdone = function (e) {
    var result = e.responseJSON;

    console.log("확인 결과:", result);

    if (result && result.success) {
        if (result.exists) {
            // 기존 데이터가 있으면 UPDATE
            console.log("기존 데이터 존재 - UPDATE 실행");
            $p.executeSubmission("sbm_updateReturnReq");
        } else {
            // 기존 데이터가 없으면 INSERT
            console.log("신규 데이터 - INSERT 실행");
            $p.executeSubmission("sbm_insertReturnReq");
        }
    } else {
        alert("데이터 확인 중 오류가 발생했습니다.");
    }
};

scwin.sbm_checkReturnReq_submiterror = function (e) {
    console.log("확인 중 에러:", e);
    $p.closePopup();
    scwin.toastAlert({
        icon: 'error',
        title: '데이터 확인 중 오류가 발생했습니다.'
    });
    return false;
};


scwin.sbm_insertReturnReq_submitdone = function (e) {
    var result = e.responseJSON;
    console.log("INSERT 결과:", result);

    if (result && result.success) {
        $p.closePopup();
        scwin.noBtnAlertWithTimer({
            icon: 'success',
            title: result.message || '반송 처리가 등록되었습니다.'
        });
        setTimeout(function () {
            location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/webWrapper.xml";
        }, 2000);
        
    } else {
        scwin.toastAlert({
            icon: 'error',
            title: result.message || '등록 중 오류가 발생했습니다.'
        });
    }
    return true;
};

scwin.sbm_insertReturnReq_submiterror = function (e) {
    console.log("등록 중 에러:", e);
    $p.closePopup();
    scwin.toastAlert({
        icon: 'error',
        title: '등록 중 오류가 발생했습니다.'
    });
    
    return false;
};


scwin.sbm_updateReturnReq_submitdone = function (e) {
    var result = e.responseJSON;
    console.log("UPDATE 결과:", result);
    $p.closePopup();
    if (result && result.success) {
        scwin.noBtnAlertWithTimer({
            icon: 'success',
            title: result.message || '반송 처리가 수정되었습니다.'
        });
        setTimeout(function() {
            location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/webWrapper.xml";
        }, 2000);
    } else {
        scwin.toastAlert({
            icon: 'error',
            title: result.message || '수정 중 오류가 발생했습니다.'
        });
    }
    return true;
};

scwin.sbm_updateReturnReq_submiterror = function (e) {
    console.log("수정 중 에러:", e);
    $p.closePopup();
    scwin.toastAlert({
        icon: 'error',
        title: '수정 중 오류가 발생했습니다.'
    });
    return false;
};


// 팝업 닫기 및 페이지 이동
scwin.closeAndRedirect = function () {
    $p.closePopup();
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/webWrapper.xml";
};

const Toast = Swal.mixin({
    toast: true,
    showConfirmButton: false,
})

scwin.toastAlertMobile = (param) => {
    Toast.fire({
        ...param,
        timer: 2000,
        position: 'center',
        timerProgressBar: false,
    });
}

scwin.toastAlert = (param) => {
    Toast.fire({
        ...param,
        timer: 3000,
        position: 'top-end',
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    });
}

scwin.noBtnAlert = (param) => {
    Swal.fire({
        ...param,
        showConfirmButton: false,
    });
}

scwin.noBtnAlertWithTimer = (param) => {
    Swal.fire({
        ...param,
        timer: 2000,
        showConfirmButton: false,
    });
}

/** 부르는 형태 예시
scwin.twoBtnAlert({
     title: "로그아웃 하시겠습니까?",
 }, (result) => {
     if (result.isConfirmed) {
         $c.sbm.execute(sbm_EmployeeLogout);
     }
 });
 */
scwin.twoBtnAlert = (param, func) => {
    Swal.fire({
        ...param,
        showCancelButton: true,
        confirmButtonColor: '#4FACFE',
        cancelButtonColor: '#d1d1d1',
        confirmButtonText: '완료',
        cancelButtonText: '취소',
        reverseButtons: true
    }).then(func);
}
]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">
    	<xf:group class="sub_contents" id="" meta_snippetCategory="00_화면시작" meta_snippetKeyComponent="true" meta_snippetName="0_01 페이지시작"
    		style="">
    		<xf:group id="">
    			<w2:span id="" label="청구 번호 : " meta_snippetCategory="10_입력폼" meta_snippetKeyComponent="true"
    				meta_snippetName="10_16 출력텍스트" style="">
    			</w2:span>
    			<w2:span meta_snippetCategory="10_입력폼" meta_snippetName="10_16 출력텍스트" meta_snippetKeyComponent="true" style=""
    				id="txt_claim_no" label="출력텍스트입니다. ">
    			</w2:span>
    		</xf:group>
    		
    		<xf:textarea class="" id="txa_additional_memo" meta_snippetCategory="10_입력폼" meta_snippetKeyComponent="true"
    			meta_snippetName="10_09 Textarea_100per" placeholder="반송 사유를 입력해주세요" style="width:100%;height: 82px;">
    		</xf:textarea>
    		<xf:group class="btnbox" id="" meta_snippetCategory="08_버튼" meta_snippetKeyComponent="true" meta_snippetName="8_05 팝업전체제어버튼"
    			style="">
    			<xf:group class="rt" id="" style="">
    				<xf:trigger class="btn_cm " id="btn_close" style="" ev:onclick="scwin.btn_close_onclick" type="button">
    					<xf:label><![CDATA[닫기]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn_cm pt" id="btn_submit" style="" type="button" ev:onclick="scwin.btn_submit_onclick">
    					<xf:label><![CDATA[확인]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    	</xf:group>
    </body>
</html>