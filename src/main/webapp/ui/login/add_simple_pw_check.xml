<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/InsWebApp/cm/css/pinNum.css" type="text/css"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
        	<w2:dataCollection baseNode="map">
        		<w2:dataMap baseNode="map" id="dma_login_request">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="간편로그인사용자" id="userId"></w2:key>
        				<w2:key dataType="text" name="간단비밀번호" id="simplePw"></w2:key>
        				<w2:key dataType="text" name="간편로그인타입" id="loginType"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dma_login_response">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="결과코드" id="resultCode"></w2:key>
        				<w2:key dataType="text" name="결과메세지" id="resultMessage"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection />
        	<xf:submission id="sbm_Simplepw_registerCheck" action="/InsWebApp/SimplePwRegisterCheck.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,[{"id":"dma_login_request","key":"elData"},{"id":"dma_login_response","key":"elData"}]' target="" encoding="UTF-8"
        		instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="scwin.sbm_Simplepw_registerCheck_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        <script lazy="false" type="text/javascript"><![CDATA[scwin.pinValue = ""; // 현재 입력된 PIN 값을 저장할 변수

scwin.onpageload = function() {
    // user 객체에서 userId 가져오기
    const userString = localStorage.getItem("user");
    const user = userString ? JSON.parse(userString) : null;
    const userId = user ? user.userId : null;
    
    // 기존 방식도 fallback으로 시도
    if (!userId) {
        userId = localStorage.getItem("userId");
    }
    
    dma_login_request.set("userId", userId);
    
    console.log("간편비밀번호 등록 확인 - 사용자 ID:", userId);
    
    // userId가 없으면 에러 처리
    if (!userId) {
        alert("사용자 정보를 가져올 수 없습니다. 다시 로그인해주세요.");
        location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/login/insure_login_mobile.xml";
        return;
    }

    // PIN 입력 상태 초기화
    scwin.updatePinDots();

}; 

/**
 * PIN 입력 상태에 따라 원형 UI를 업데이트하는 함수
 */
scwin.updatePinDots = function() {
    var currentLength = scwin.pinValue.length;
    
    for (var i = 1; i <= 6; i++) {
        var dot = $p.getComponentById("dot" + i);
        if (dot) {
            if (i <= currentLength) {
                
                dot.setStyle("background-color", "#4facfe");
                dot.setStyle("transform", "scale(1.1)");
            } else {
                dot.setStyle("background-color", "#e0e0e0");
                dot.setStyle("transform", "scale(1)");
            }
        }
    }
};

/**
 * 숫자 키패드 버튼 클릭 시 공통으로 실행될 함수
 * @param {string} num - 클릭된 버튼의 숫자
 */
scwin.onNumberKeyClick = function(num) {
    if (scwin.pinValue.length >= 6) return;

    scwin.pinValue += num;
    scwin.updatePinDots();

  // 6자리가 모두 입력되었으면 처리
    if (scwin.pinValue.length === 6) {
        
        try {
            // 확인용 PIN이므로 별도의 데이터맵에 설정합니다.
            dma_login_request.set("simplePw", scwin.pinValue);
            
        
            let reqData = { "elData": dma_login_request.getJSON() };

            console.log("간편비밀번호 최종 등록 요청 데이터:", reqData);
        

        // submission 실행 전 검증
        if (typeof sbm_Simplepw_registerCheck === 'undefined') {
            console.error("sbm_Simplepw_register가 정의되지 않았습니다.");
            alert("로그인 설정에 오류가 있습니다. 관리자에게 문의하세요.");
            return;
        }
        
            $c.sbm.execute(sbm_Simplepw_registerCheck, reqData);
        
        } catch (error) {
            console.error("최종 등록 요청 실패:", error);
            alert("처리 중 오류가 발생했습니다.");
            scwin.resetPassword();
        }
        
    }

    
};



scwin.resetPassword = function() {
    scwin.pinValue = "";

    scwin.updatePinDots();

    txt_info.setValue("비밀번호를 입력하세요");
};


scwin.sbm_Simplepw_registerCheck_submitdone = function (e) {
    var resData = e.responseJSON.dma_login_response;

    if (resData && resData.resultCode === "OK") {
        // 성공 시: 메인페이지로 이동
        //location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/login/insure_login_mobile.xml&userId=" + localStorage.getItem("userId");
        location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/Assignment/m_home.xml";
    
    } else {
        // 실패 시: 안내 문구 변경 및 입력값 초기화
        var message = resData ? resData.resultMessage : "PIN 등록에 실패했습니다.";
        // txt_info 컴포넌트가 없다면 이 줄에서 에러가 날 수 있습니다.
        txt_info.setValue(message); 
        alert(message);
        
        //txt_info.setValue(resData.resultMessage || "등록 중 오류가 발생했습니다.");
        scwin.pinValue = ""; // 저장된 PIN 값 초기화
        scwin.updatePinDots(); // 원형 UI 초기화
    }
};


scwin.btn_clear_onclick = function (e) {
    scwin.pinValue = ""; // 저장된 PIN 값 전체 삭제
    scwin.updatePinDots(); // 원형 UI 초기화
};


scwin.btn_delete_onclick = function (e) {
    if (scwin.pinValue.length > 0) {
        scwin.pinValue = scwin.pinValue.slice(0, -1);
        scwin.updatePinDots();
    }
};
]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload"
    	style="display: flex;flex-direction: column;justify-content: space-between;align-items: center;width: 100%;max-width: 450px;height: 100vh;margin: 0 auto;">
    	<xf:group style="width: 100%;height: 100%;display: flex;justify-content: center;align-items:center" id="">
    		<xf:group meta_snippetCategory="00_화면시작" meta_snippetName="0_01 페이지시작" meta_snippetKeyComponent="true" style="" id=""
    			class="pin-wrapper">
    			<w2:textbox style="" id="txt_info1" label="간편 비밀번호 확인" class="pin-wrapper textTitle"></w2:textbox>
    			<w2:textbox style="" id="txt_info2" label="간편 비밀번호 6자리를 한 번 더 입력해 주세요." class="pin-wrapper text"></w2:textbox>
    			<xf:group style="height: 30px;text-align:center;display: flex; justify-content: center; padding-bottom: 80px;" id="">
    				<xf:group style="width:178px;height:30px;display:flex;gap:5px;justify-content: center;align-items: center;margin: 0;"
    					id="">
    					<xf:group
    						style="width: 22px;height: 22px;background-color: #e0e0e0;border-radius: 50%transition: background-color 0.3s ease;border-radius: 50%;"
    						id="dot1" class="pin_dot">
    					</xf:group>
    					<xf:group
    						style="width: 22px;height: 22px;background-color: #e0e0e0;border-radius: 50%transition: background-color 0.3s ease;border-radius: 50%;"
    						id="dot2" class="pin_dot">
    					</xf:group>
    					<xf:group
    						style="width: 22px;height: 22px;background-color: #e0e0e0;border-radius: 50%transition: background-color 0.3s ease;border-radius: 50%;"
    						id="dot3" class="pin_dot">
    					</xf:group>
    					<xf:group
    						style="width: 22px;height: 22px;background-color: #e0e0e0;border-radius: 50%transition: background-color 0.3s ease;border-radius: 50%;"
    						id="dot4" class="pin_dot">
    					</xf:group>
    					<xf:group style="width:22px;height:22px;background-color:#e0e0e0;border-radius:50%;" id="dot5" class="pin_dot">
    					</xf:group>
    					<xf:group
    						style="width: 22px;height: 22px;background-color: #e0e0e0;border-radius: 50%transition: background-color 0.3s ease;border-radius: 50%;"
    						id="dot6" class="pin_dot">
    					</xf:group>
    				</xf:group>
    			</xf:group>
    			<xf:group meta_snippetCategory="01_화면분할" meta_snippetName="1_03 가변 3단 분할_width값 고정 33per" meta_snippetKeyComponent="true"
    				style="display: grid;flex: 1;grid-template-columns: repeat(3, 1fr);gap: 1px;width: 100%;box-sizing: border-box;" id=""
    				class="keypad">
    				<w2:button ev:onclick="scwin.onNumberKeyClick('1')" style="" id="btn1" label="1" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('2')" style="" id="btn2" label="2" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('3')" style="" id="btn3" label="3" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('4')" style="" id="btn4" label="4" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('5')" style="" id="btn5" label="5" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('6')" style="" id="btn6" label="6" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('7')" style="" id="btn7" label="7" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('8')" style="" id="btn8" label="8" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('9')" style="" id="btn9" label="9" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.btn_clear_onclick" style="" id="btn_clear" label="취소" class="pin-wrapper key text-key"></w2:button>
    				<w2:button ev:onclick="scwin.onNumberKeyClick('0')" style="" id="btn0" label="0" class="pin-wrapper key"></w2:button>
    				<w2:button ev:onclick="scwin.btn_delete_onclick" style="" id="btn_delete" class="pin-wrapper key icon-key">
    					<xf:image src="/InsWebApp/images/insure/delete.png" style="width:30px;	height:30px;object-fit:contain;" id=""
    						class="icon-image">
    					</xf:image>
    				</w2:button>
    			</xf:group>
    		</xf:group>
    	</xf:group>
    </body>
</html>
