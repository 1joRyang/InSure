<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/InsWebApp/cm/css/claimPage.css" type="text/css"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare"
    xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
    	<w2:type>DEFAULT</w2:type>
    	<w2:buildDate />
    	<xf:model>
    		<xf:instance>
    			<data xmlns="" />
    		</xf:instance>
    		<w2:dataCollection baseNode="map">
    			<w2:dataMap baseNode="map" id="dma_step5">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="name1" id="s3FileKeys"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_getS3Url">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="name1" id="filename"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    		</w2:dataCollection>
    		<xf:submission id="sbm_saveStep5" action="/InsWebApp/saveStep5.pwkjson" method="post" mediatype="application/json"
    			ref='data:json,{"id":"dma_step5","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
    			mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_saveStep5_submitdone" ev:submiterror="" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_getS3Url" action="/InsWebApp/getS3UploadUrl.pwkjson" method="post" mediatype="application/json"
    			ref='data:json,{"id":"dma_getS3Url","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
    			customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getS3Url_submitdone" ev:submiterror=""
    			abortTrigger="">
    		</xf:submission>
    	</xf:model>
    	<w2:leaf>true</w2:leaf>
    	<w2:fileName>final_check_modified_v2.xml</w2:fileName>
    	<w2:css src="/css/custom.css"></w2:css>
    	<w2:js src="/js/final_check.js"></w2:js>
    	<style type="text/css"><![CDATA[
            /* Basic Reset & Font */
            body {
                margin: 0;
                padding: 0;
                background-color: #f0f2f5;
                font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "맑은 고딕", helvetica, "Apple SD Gothic Neo", sans-serif;
            }

            /* Main Wrapper */
            .wrapper {
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            /* Card Style */
            .card {
                background-color: #ffffff;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }

            /* Notification Box */
            .notification-box {
                background-color: #fffbeb;
                border: 1px solid #ffe58f;
                border-radius: 8px;
                padding: 16px;
                font-size: 14px;
                color: #5c3a00;
            }

            /* Claim Info Section */
            .claim-title {
                font-size: 20px;
                font-weight: bold;
                color: #1d1d1d;
                margin-bottom: 16px;
            }

            .info-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 15px;
                margin-bottom: 8px;
            }
            .info-row:last-child {
                margin-bottom: 0;
            }

            .info-label {
                color: #555;
            }

            .info-value {
                color: #1d1d1d;
                font-weight: 500;
            }

            /* Section Title */
            .section-title {
                font-size: 16px;
                font-weight: bold;
                color: #333;
                margin-bottom: 12px;
                display: block; /* to apply margin-bottom */
            }
             .sub-section-title {
                font-size: 15px;
                font-weight: bold;
                color: #444;
                margin-top: 16px;
                margin-bottom: 12px;
                display: block;
            }

            /* Required Docs List */
            .required-docs ul {
                list-style-type: none;
                padding-left: 18px;
                margin: 0;
            }
            .required-docs li {
                font-size: 15px;
                color: #d9534f;
                position: relative;
            }
            .required-docs li::before {
                content: "•";
                color: #d9534f;
                font-weight: bold;
                display: inline-block;
                width: 1em;
                margin-left: -1em;
                position: absolute;
                left: -8px;
            }
            
            /* Document Management */
            .submitted-file {
                display: flex;
                align-items: center;
                background-color: #f8f9fa;
                border-radius: 8px;
                padding: 12px;
                font-size: 14px;
                color: #333;
            }
            .submitted-file-icon {
                width: 20px;
                height: 20px;
                margin-right: 10px;
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>');
            }

            #previewBox {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                width: 100%;
                min-height: 100px; /* 최소 높이 지정 */
                background-color: #f8f9fa;
                border-radius: 8px;
                padding: 10px;
                box-sizing: border-box; /* 패딩이 크기에 포함되도록 설정 */
            }
            #previewBox:empty::before {
                content: "선택된 파일이 없습니다.";
                color: #888;
                font-size: 14px;
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                height: 100%;
                grid-column: 1 / -1; /* 내용을 그리드 전체에 걸치도록 설정 */
            }

            /* Buttons */
            .attachment-buttons {
                display: flex;
                gap: 10px;
                width: 100%;
            }
            .btn_cm {
                flex: 1;
                height: 48px;
                border-radius: 8px;
                font-size: 15px;
                font-weight: 500;
                border: 1px solid #ccc;
                background-color: #ffffff;
                cursor: pointer;
            }
            .submit-button-container {
                padding: 10px 20px;
                background-color: #f0f2f5;
                position: sticky;
                bottom: 0;
            }
            .submit-button {
                width: 100%;
                height: 52px;
                background-color: #0d6efd;
                border: none;
                border-radius: 12px;
                color: white;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
            }

    	]]></style>
        <script lazy="false" type="text/javascript"><![CDATA[
            scwin.isEditMode = false;
            scwin.onpageload = function() {
                var urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('mode') === 'edit') {
                    scwin.isEditMode = true;
                }
                var previewBox = document.querySelector('[id$="previewBox"]');
                if (previewBox) {
                    previewBox.addEventListener('click', function(event) {
                        if (event.target.classList.contains('delete-btn')){
                            var wrapperId = event.target.getAttribute('data-wrapper-id');
                            var elementToDelete = document.getElementById(wrapperId);
                            if (elementToDelete) {
                                elementToDelete.remove();
                            }
                        }
                    });
                }
            };
            
            scwin.dataURItoBlob = function(dataURI) {
                var byteString = atob(dataURI.split(',')[1]);
                var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                var ab = new ArrayBuffer(byteString.length);
                var ia = new Uint8Array(ab);
                for (var i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], {type: mimeString});
            };
            
            scwin.uploadQueue = [];
            scwin.uploadedFileKeys = [];
            
            scwin.btnNext_onclick = async function (e) {
                var previewBox = document.querySelector('[id$="previewBox"]');
                var images = previewBox.querySelectorAll('img');
                if (images.length === 0) {
                    alert("첨부된 서류가 없습니다.");
                    return;
                }
                
                scwin.uploadQueue = [];
                scwin.uploadedFileKeys = [];
                
                images.forEach(function(img, index) {
                    scwin.uploadQueue.push({
                        filename: "image" + index + ".jpg",
                        src: img.src
                    });
                });
                
                scwin.processNextFileInQueue();
            };
            
            scwin.currentFileForUpload = null;
            
            scwin.processNextFileInQueue = function(){
                if (scwin.uploadQueue.length > 0) {
                    var fileToUpload = scwin.uploadQueue.shift();
                    scwin.currentFileForUpload = fileToUpload;
                    dma_getS3Url.set("filename", fileToUpload.filename);
                    $p.executeSubmission("sbm_getS3Url");
                } else {
                    console.log("모든 파일 업로드 완료. 서버에 최종정보 저장시도");
                    scwin.saveFileKeysToServer();
                }
            };
            
            scwin.sbm_getS3Url_submitdone = function (e) {
                var presignedUrl = e.responseJSON.elData.presignedUrl;
                var objectKey = e.responseJSON.elData.objectKey;
                var originalFile = scwin.currentFileForUpload;
                var blob = scwin.dataURItoBlob(originalFile.src);
                fetch(presignedUrl, { method: 'PUT', body: blob})
                    .then(response => {
                        if (response.ok) {
                            console.log(objectKey + "S3 업로드 성공");
                            scwin.uploadedFileKeys.push(objectKey);
                            scwin.processNextFileInQueue();
                        } else {
                            throw new Error("S3 업로드 실패");
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        alert("파일 업로드 중 오류발생");
                    });
            };
            
            scwin.saveFileKeysToServer = function() {
                var s3KeysAsString = scwin.uploadedFileKeys.join(',');
                var postData = { "s3FileKeys": s3KeysAsString };
                dma_step5.setJSON(postData);
                $p.executeSubmission("sbm_saveStep5");
            };
            
            scwin.btn_camera_onclick = function() {
                var options = { quality: 70, destinationType: $h.camera.DestinationType.DATA_URL, sourceType: $h.camera.PictureSourceType.CAMERA, encodingType: $h.camera.EncodingType.JPEG, mediaType: $h.camera.MediaType.PICTURE, allowEdit: false, saveToPhotoAlbum: true };
                $h.camera.capturePhoto(scwin.camera_callback,options);
            };
            
            scwin.btn_gallery_onclick = function() { 
                 var options = { quality: 70, destinationType: $h.camera.DestinationType.DATA_URL, sourceType: $h.camera.PictureSourceType.PHOTOLIBRARY, encodingType: $h.camera.EncodingType.JPEG, mediaType: $h.camera.MediaType.PICTURE, allowEdit: false, correctOrientation: false };
                $h.camera.capturePhoto(scwin.camera_callback,options);
            };
            
            scwin.camera_callback = function(r){
                var imageData = "";
                if(r.data && r.data.callbackURI){ imageData = r.data.callbackURI; } 
                else if (r.data && r.data.image){ imageData = "data:image/jpeg;base64," + r.data.image; }
                
                if(imageData){
                    var parentDiv = document.querySelector('[id$="previewBox"]');
                    if(parentDiv){
                        var wrapperId = "wrapper_" + new Date().getTime();
                        var imageHTML = `
                            <div id="${wrapperId}" style="position: relative;">
                                <img src="${imageData}" style="width:100%; height:100px;border-radius:8px; object-fit:cover;">
                                <span class="delete-btn" data-wrapper-id="${wrapperId}" style="position: absolute; top:5px; right:5px; width:22px; height:22px; line-height:22px; text-align:center; background-color:rgba(0,0,0,0.6); color: white; border-radius:50%; cursor:pointer; font-weight:bold;">X</span>
                            </div>
                        `;
                        parentDiv.innerHTML += imageHTML;
                    } else { console.error("부모DOM못찾음"); }
                }
            };
            
            scwin.sbm_saveStep5_submitdone = function (e) {
                // 수정 완료 후 이동할 페이지
                location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/completion.xml";
            };
		]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">
        <xf:group class="wrapper" id="mainWrapper" style="">
            
            <xf:group class="notification-box" id="">
                <w2:textbox id="" label="보험금 심사를 위해 서류를 추가로 제출해주시기 바랍니다. 기한 내 미제출 시 반송될 수 있습니다." style=""></w2:textbox>
            </xf:group>

            <xf:group class="card" id="">
                <w2:textbox class="claim-title" id="" label="CLM-2025-001" style=""></w2:textbox>
                <xf:group class="info-row" id="">
                    <w2:textbox class="info-label" id="" label="청구 유형"></w2:textbox>
                    <w2:textbox class="info-value" id="" label="실손의료비"></w2:textbox>
                </xf:group>
                <xf:group class="info-row" id="">
                    <w2:textbox class="info-label" id="" label="현재 상태"></w2:textbox>
                    <w2:textbox class="info-value" id="" label="지급 완료"></w2:textbox>
                </xf:group>
                <xf:group class="info-row" id="">
                    <w2:textbox class="info-label" id="" label="담당자"></w2:textbox>
                    <w2:textbox class="info-value" id="" label="김심사"></w2:textbox>
                </xf:group>
            </xf:group>

            <xf:group class="card required-docs" id="">
                <w2:textbox class="section-title" id="" label="요청 사유 및 필요서류"></w2:textbox>
                 <ul>
                     <li>
                         <w2:textbox id="" label="진단서 원본 필요"></w2:textbox>
                     </li>
                 </ul>
            </xf:group>

            <xf:group class="card" id="">
                <w2:textbox class="section-title" id="" label="서류관리"></w2:textbox>
                
                <xf:group class="submitted-file" id="">
                    <xf:group class="submitted-file-icon" id=""></xf:group>
                    <w2:textbox id="" label="기존_제출서류.png"></w2:textbox>
                </xf:group>
                
                <w2:textbox class="sub-section-title" id="" label="보완 서류 등록"></w2:textbox>

                <xf:group class="attachment-buttons" id="">
                    <xf:trigger type="button" ev:onclick="scwin.btn_camera_onclick" id="btn_camera" class="btn_cm">
                        <xf:label><![CDATA[카메라 촬영]]></xf:label>
                    </xf:trigger>
                    <xf:trigger type="button" ev:onclick="scwin.btn_gallery_onclick" id="btn_gallery" class="btn_cm">
                        <xf:label><![CDATA[갤러리에서 선택]]></xf:label>
                    </xf:trigger>
                </xf:group>
                
                <w2:textbox class="sub-section-title" id="" label="보완 서류 첨부내역"></w2:textbox>

                <xf:group class="infoBox" id="previewBox"></xf:group>
            </xf:group>
            
        </xf:group>
        
        <xf:group class="footer-section submit-button-container" id="footer" style="">
            <w2:button class="submit-button" id="btnNext" label="보완 서류 제출" ev:onclick="scwin.btnNext_onclick"></w2:button>
        </xf:group>
    </body>
</html>