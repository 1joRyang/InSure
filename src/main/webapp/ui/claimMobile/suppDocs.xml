<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/InsWebApp/cm/css/claimPage.css" type="text/css"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare"
    xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
    	<w2:type>DEFAULT</w2:type>
    	<w2:buildDate />
    	<xf:model>
    		<xf:instance>
    			<data xmlns="" />
    		</xf:instance>
    		<w2:dataCollection baseNode="map">
    			<w2:dataMap baseNode="map" id="elData">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="name1" id="insimagefileVoList"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_claimData">
    				<w2:keyInfo></w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_request">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="청구번호" id="claimNo"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_suppInfo">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="청구번호" id="claimNo"></w2:key>
    					<w2:key dataType="text" name="청구유형" id="claimType"></w2:key>
    					<w2:key dataType="text" name="현재 상태" id="status"></w2:key>
    					<w2:key dataType="text" name="담당자이름" id="empName"></w2:key>
    					<w2:key dataType="text" name="보완요청사유" id="additionalMemo"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_getS3Url">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="name1" id="filename"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_s3_info">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="업로드URL" id="presignedUrl"></w2:key>
    					<w2:key dataType="text" name="파일키" id="objectKey"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_final_docs">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="청구번호" id="claimNo"></w2:key>
    					<w2:key dataType="text" name="s3fileKeys" id="s3fileKeys"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    		</w2:dataCollection>
    		<xf:submission id="submission1" action="/InsWebApp/submitClaim.pwkjson" method="post" mediatype="application/json"
    			ref='data:json,{"id":"elData","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
    			mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.submission1_submitdone"
    			ev:submiterror="scwin.submission1_submiterror" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_getClaimData" action="/InsWebApp/getClaimData.pwkjson" method="post" mediatype="application/json" ref=''
    			target='data:json,{"id":"dma_claimData","key":"elData"}' encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
    			mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getClaimData_submitdone" ev:submiterror="" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_submitFinalClaim" action="/InsWebApp/submitFinalClaim.pwkjson" method="post" mediatype="application/json"
    			ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
    			processMsg="청구서를 제출하고 있습니다..." ev:submit="" ev:submitdone="scwin.sbm_submitFinalClaim_submitdone"
    			ev:submiterror="scwin.sbm_submitFinalClaim_submiterror" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_getSupplementInfo" action="/InsWebApp/getSupplementInfo.pwkjson" method="post"
    			mediatype="application/json" ref='data:json,{"id":"dma_request","key":"elData"}'
    			target='data:json,{"id":"dma_suppInfo","key":"elData"}' encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
    			mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getSupplementInfo_submitdone" ev:submiterror=""
    			abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_getS3Url" action="/InsWebApp/getS3UploadUrl.pwkjson" method="post" mediatype="application/json"
    			ref='data:json,{"id":"dma_getS3Url","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
    			customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getS3Url_submitdone" ev:submiterror=""
    			abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_addSupplementDocs" action="/InsWebApp/addSupplementDocs.pwkjson" method="post"
    			mediatype="application/json" ref='data:json,{"id":"dma_final_docs","key":"elData"}' target="" encoding="UTF-8" instance="" replace=""
    			errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
    			ev:submitdone="scwin.sbm_addSupplementDocs_submitdone" ev:submiterror="" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_updateComplete" action="/InsWebApp/updateSupplementComplete.pwkjson" method="post" mediatype="application/json" ref='data:json,{"id":"dma_final_docs","key":"suppVo"}' target='data:json,{"id":"dma_final_docs","key":"suppVo"}' encoding="UTF-8"
    			instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_updateComplete_submitdone"
    			ev:submiterror="" abortTrigger="">
    		</xf:submission>
    	</xf:model>
    	<w2:leaf>true</w2:leaf>
    	<w2:fileName>final_check.xml</w2:fileName>
    	<w2:css src="/css/custom.css"></w2:css>
    	<w2:js src="/js/final_check.js"></w2:js>
    	<w2:engine-version>5.0.0</w2:engine-version>
        <script lazy="false" type="text/javascript"><![CDATA[scwin.uploadQueue = [];
scwin.uploadedFileKeys = [];
scwin.currentFileForUpload = null;

scwin.onpageload = function() {
    const claimJson = localStorage.getItem("claim");
    console.log("1. 로컬 스토리지에서 가져온 claim 데이터: ", claimJson);

    if(claimJson) {
        //2. JSON 문자열을 객체로 변환
        const claimData = JSON.parse(claimJson);
        // 3. dataMap에 claimNo설정
        dma_request.set("claimNo", claimData.claimNo);
        // 4. 서브미션을 ID로만 호출
        $p.executeSubmission("sbm_getSupplementInfo");
        // 5. 사용한 데이터는 로컬 스토리지에서 삭제
        localStorage.removeItem("claim");
    } else {
        console.error("로컬 스토리지에 claim 데이터가 없습니다.");
    }
    // 1. URL에서 claimNo 가져오기
    //const urlParams = new URLSearchParams(window.location.search);
    //const claimNo = urlParams.get('claimNo');
    //console.log("1. URL에서 가져온 claimNo:", claimNo);

    //if (claimNo) {
        // 2. dataMap에 claimNo 설정
        //dma_request.set("claimNo", claimNo);
        
        // 3. submission을 ID로만 호출
        //$p.executeSubmission("sbm_getSupplementInfo");
    //} else {
    //    console.error("URL에 claimNo 파라미터가 없습니다.");
    //}

	// 미리보기 부모영역 찾기
    var previewBox = document.querySelector('[id$="previewBox"]');

    if (previewBox) {
        // 부모 영역에 클릭 이벤트 리스너를 추가
        previewBox.addEventListener('click', function(event) {
            // 클릭된 요소가 '삭제 버튼'인지 확인
            if (event.target.classList.contains('delete-btn')){
                //삭제할 부모 wrapper의 ID를 data- 속성에서 가져오기
                var wrapperId = event.target.getAttribute('data-wrapper-id');
                var elementToDelete = document.getElementById(wrapperId);

                if (elementToDelete) {
                    elementToDelete.remove();
                }
            }
        });
    }
};

// Camera Plugin 사진촬영
scwin.btn_camera_onclick = function() {
    var options = {
        quality: 70,
        destinationType: $h.camera.DestinationType.DATA_URL,
        sourceType: $h.camera.PictureSourceType.CAMERA,
        encodingType: $h.camera.EncodingType.JPEG,
        mediaType: $h.camera.MediaType.PICTURE,
        allowEdit: false,
        saveToPhotoAlbum: true
    };

   $h.camera.capturePhoto(scwin.camera_callback,options);
};

// Camera Plugin 갤러리(사진 가져오기)
scwin.btn_gallery_onclick = function() { 
     var options = {
        quality: 70,
        destinationType: $h.camera.DestinationType.DATA_URL,
        sourceType: $h.camera.PictureSourceType.PHOTOLIBRARY,
        encodingType: $h.camera.EncodingType.JPEG,
        mediaType: $h.camera.MediaType.PICTURE,
        allowEdit: false,
        correctOrientation: false
    };

    $h.camera.capturePhoto(scwin.camera_callback,options);
};

// 사진 선택 후 결과가 전달되는 함수
scwin.camera_callback = function(r){

    console.log("카메라/갤러리에서 받은 정보:" , r);

    // 1. 이미지 데이터(base64) 추출
    var imageData = "";
    if(r.data && r.data.callbackURI){
        //ios & 최신 버전
        imageData = r.data.callbackURI;
    } else if (r.data && r.data.image){
        // 구형 Android
        imageData = "data:image/jpeg;base64," + r.data.image;
    }

    // 2. 이미지 데이터 있을 경우에만 미리보기 생성
    if(imageData){
        // 3. WebSquare API($p) 대신 순수 자바스크립트로 DOM요소 찾기
        // WebSquare는 컴포넌트에 고유한 접미사를 붙이므로,
        // ID가 "previewBox"로 끝나는 요소 찾기
        var parentDiv = document.querySelector('[id$="previewBox"]');

        if(parentDiv){
            console.log("순수 JS로 부모DOM 찾음:",parentDiv);

            var wrapperId = "wrapper_" + new Date().getTime();
            
            // 4. 새로 추가할 이미지와 삭제버튼을 포함한 태그를 HTML 문자열로 만듦
            //var imageHTML='<img src="'+imageData+'" style="width:100%; height:100px; border-radius:8px; object-fit:cover;">';
            var imageHTML = `
                <div id="${wrapperId}" style="position: relative;">
                    <img src="${imageData}" style="width:100%; height:100px;border-radius:8px; object-fit:cover;">
                    <span class="delete-btn" data-wrapper-id="${wrapperId}"
                        style="position: absolute; top:5px; right:5px; width:22px; height:22px; line-height:22px; text-align:center; background-color:rgba(0,0,0,0.6); color: white; border-radius:50%; cursor:pointer; font-weight:bold;">
                    X
                    </span>
                </div>
            `;


            // 5. 부모 요소의 내부에 HTML을 직접 추가
            // 'innerHTML += '는 기존 내용을 유지하면서 뒤에 새로운 내용을 추가하는 방식
            parentDiv.innerHTML += imageHTML;
        } else {
            console.error("부모DOM못찾음");
        }
    }
};


scwin.dataURItoBlob = function(dataURI){
    var byteString = atob(dataURI.split(',')[1]);
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++){
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab],{type:mimeString});
};

scwin.btnNext_onclick = function () {
    const previewBox = document.querySelector('[id$="previewBox"]');
    const images = previewBox.querySelectorAll('img');
    if (images.length === 0) {
        alert("보완 서류를 등록해주세요.");
        return;
    }
    scwin.uploadQueue = [];
    scwin.uploadedFileKeys = [];
    images.forEach(img => scwin.uploadQueue.push(img.src));
    scwin.processNextFileInQueue();
};

// 순차적 업로드 처리 함수
scwin.processNextFileInQueue = function(){
    if (scwin.uploadQueue.length > 0) {
        scwin.currentFileForUpload = scwin.uploadQueue[0];
        dma_getS3Url.set("filename", "supplement-image.jpg");
        $p.executeSubmission("sbm_getS3Url");
    } else {
        console.log("모든 파일 업로드 완료. DB에 최종 정보 저장 시도");
        scwin.saveFileKeysToServer();
    }
}


scwin.sbm_getSupplementInfo_submitdone = function (e) {
    console.log("6. 서버로부터 최종 응답 받음:", e.responseJSON); 
};

scwin.sbm_getS3Url_submitdone = function (e) {
    const presignedUrl = e.responseJSON.elData.presignedUrl;
    const objectKey = e.responseJSON.elData.objectKey;
    const imageSrc = scwin.uploadQueue.shift();

    console.log("서버로부터 받은 presignedUrl:", presignedUrl);
    console.log("서버로부터 받은 objectKey:", presignedUrl);

    if (!presignedUrl) {
        alert("파일 업로드 URL을 받아오지 못했습니다.");
        return;
    }

    // Base64데이터를 Blob으로 변환
    const byteString = atob(imageSrc.split(',')[1]);
    const mimeString = imageSrc.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    const blob = new Blob([ab], {type : mimeString});

    // fetch API를 사용해 S3로 직접 파일 업로드
    fetch(presignedUrl, {method: 'PUT', body:blob})
        .then(response => {
            if(response.ok) {
                console.log(objectKey + "S3 업로드 성공");
                scwin.uploadedFileKeys.push(objectKey);
                scwin.processNextFileInQueue();
            } else { throw new Error("S3 업로드 실패");}
        })
        .catch(error => {
            console.error(error);
            alert("파일 업로드 중 오류가 발생했습니다.");
        });
};

scwin.sbm_addSupplementDocs_submitdone = function (e) {
    console.log("1. 파일 키 저장 성공. 이어서 보완 완료 처리를 시작합니다.");
    $p.executeSubmission("sbm_updateComplete");
};

scwin.saveFileKeysToServer = function() {
    // 이 화면에서 조회했던 청구번호 가져옴
    const claimNo = dma_suppInfo.get("claimNo");
    // S3 업로드에 성공한 파일 키를 쉼표로 연결
    const s3KeysString = scwin.uploadedFileKeys.join(',');

    dma_final_docs.set("claimNo", claimNo);
    dma_final_docs.set("s3fileKeys", s3KeysString);

    $p.executeSubmission("sbm_addSupplementDocs");
}

scwin.sbm_updateComplete_submitdone = function (e) {
    alert("보완 서류가 정상적으로 제출되었습니다.");
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/Assignment/m_home.xml";
};
]]></script>
    	<style type="text/css"><![CDATA[/* custom.css */

/*
  ======================================
  Common Styles
  ======================================
*/
.pageWrapper {
    font-family: 'Malgun Gothic', 'Dotum', sans-serif;
    background-color: #f7f7f7;
}

/* Header and Progress Bar */
.pageWrapper > xf\:group:first-child > xf\:group:first-child {
    background-color: #ffffff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

#progressBar {
    height: 100%;
    background-color: #ffc107;
    transition: width 0.5s ease-in-out;
}

.stepIndicatorContainer {
    padding-top: 10px;
}

.progressBtn {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 2px solid #ccc;
    background-color: #fff;
    color: #ccc;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    cursor: default;
}

.progressBtn.completed {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #fff;
}

.progressBtn.active {
    background-color: #fff;
    border-color: #ffc107;
    color: #ffc107;
}

/* Scrollable Main Content Wrapper */
#mainContentWrapper {
    flex: 1; /* Take up all remaining space */
    overflow-y: auto; /* Enable vertical scrolling */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

/* Section titles */
.sectionTitle {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

/* Info Box */
.infoBox {
    width: 100%;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Info Row for key-value pairs */
.infoRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.infoLabel {
    font-weight: bold;
    color: #555;
    flex-shrink: 0;
    margin-right: 15px;
}

.infoValue {
    font-weight: 500;
    color: #222;
    text-align: right;
}

/* Text Button (e.g., '수정') */
.textButton {
    background-color: transparent;
    border: none;
    color: #888;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}

/* Selection Buttons (e.g., '네/아니오') */
.selectionBtn {
    background-color: #fff;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    cursor: pointer;
}

.selectionBtn:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.selectionBtn.selected {
    border-color: #ffc107;
    background-color: #fff8e1;
}

.selectionBtn.half {
    flex: 1;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
}

/* Fixed Bottom Button */
.nextBtn {
    width: 100%;
    height: 65px;
    background-color: #ffc107;
    border-radius: 35px;
    color: white;
    font-size: 22px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: background-color 0.2s;
}

.nextBtn:hover {
    background-color: #ffb300;
}

/* Scroll to Top button */
#scrollTopBtn {
    z-index: 100; /* Ensure it's on top */
    cursor: pointer;
}

/* Icon Styles (You must provide the actual image paths) */
.icon {
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}
.questionIcon { background-image: url('/images/question_icon.png'); width: 16px; height: 16px; }
.arrowUpIcon { background-image: url('/images/arrow_up_icon.png'); }]]></style>
    </head>
    <body ev:onpageload="scwin.onpageload">
        <xf:group class="sub_contents2" id="wrapper" style="">
            <xf:group class="content-section" id="mainContent" style="margin:0 auto;">
                <xf:group class="notification-box" id="">
                    <w2:textbox id="" label="보험금 심사를 위해 서류를 추가로 제출해주시기 바랍니다. 기한 내 미제출 시 반송될 수 있습니다." style=""></w2:textbox>
                </xf:group>

                <xf:group class="infoSection">
                    <xf:group class="infoBox">
                        <w2:textbox class="claim-title" id="tbx_claimNo" ref="data:dma_suppInfo.claimNo" style=""></w2:textbox>
                        <xf:group class="info-row" id="">
                            <w2:textbox class="info-label" id="" label="청구 유형"></w2:textbox>
                            <w2:textbox class="info-value" id="tbx_claimType" ref="data:dma_suppInfo.claimType"></w2:textbox>
                        </xf:group>
                        <xf:group class="info-row" id="">
                            <w2:textbox class="info-label" id="" label="현재 상태"></w2:textbox>
                            <w2:textbox class="info-value" id="tbx_status" ref="data:dma_suppInfo.status"></w2:textbox>
                        </xf:group>
                        <xf:group class="info-row" id="">
                            <w2:textbox class="info-label" id="" label="담당자"></w2:textbox>
                            <w2:textbox class="info-value" id="tbx_empName" ref="data:dma_suppInfo.empName"></w2:textbox>
                        </xf:group>
                    </xf:group>
                </xf:group>
                
                <xf:group class="infoSection">
                    <xf:group style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <w2:span label="서류안내" class="sectionTitle"></w2:span>
                    </xf:group>
                    
                    <xf:group class="infoBox" style="padding: 20px;">
                        <w2:span id="additionalMemo" ref="data:dma_suppInfo.additionalMemo" style="line-height: 1.5;"></w2:span>
                    </xf:group>
                </xf:group>

                <xf:group class="infoSection">
            			<w2:span style="" label="보완서류 등록" class="sectionTitle"></w2:span>
            			<xf:group style="display: flex; gap: 10px; margin-top:10px;">
            				<xf:trigger type="button" ev:onclick="scwin.btn_camera_onclick" style="flex:1;height:50px;border-radius:10px;" id="btn_camera" class="btn_cm">
                                <xf:label><![CDATA[카메라 촬영]]></xf:label>
                            </xf:trigger>
                            <xf:trigger type="button" ev:onclick="scwin.btn_gallery_onclick" style="flex:1;height:50px;border-radius:10px;" id="btn_gallery" class="btn_cm">
                                <xf:label><![CDATA[갤러리에서 선택]]></xf:label>
                            </xf:trigger>

            			</xf:group>
            	</xf:group>

            	<xf:group class="infoSection">
            		<w2:span label="보완서류 첨부내역" class="sectionTitle"></w2:span>
            		<xf:group class="infoBox" id="previewBox" style="display: grid;    grid-template-columns: repeat(3, 1fr);    gap: 10px;"></xf:group>
            	</xf:group>
                
            </xf:group>

            <xf:group style="height: 50px;"></xf:group>

            <xf:group class="footer-section" id="footer" style="">
                <w2:button class="next-button" id="btnNext" label="보완" ev:onclick="scwin.btnNext_onclick"></w2:button>
            </xf:group>
        </xf:group>
    </body>
</html>