<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/InsWebApp/cm/css/claimPage.css" type="text/css"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare"
    xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    	<w2:type>DEFAULT</w2:type>
    	<w2:buildDate />
    	<xf:model>
    		<xf:instance>
    			<data xmlns="" />
    		</xf:instance>
    		<w2:dataCollection baseNode="map">
    			<w2:dataMap baseNode="map" id="elData">
    				<w2:keyInfo>
    					<w2:key dataType="text" name="name1" id="insimagefileVoList"></w2:key>
    				</w2:keyInfo>
    			</w2:dataMap>
    			<w2:dataMap baseNode="map" id="dma_claimData">
    				<w2:keyInfo></w2:keyInfo>
    			</w2:dataMap>
    		</w2:dataCollection>
    		<xf:submission id="submission1" action="/InsWebApp/submitClaim.pwkjson" method="post" mediatype="application/json"
    			ref='data:json,{"id":"elData","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
    			mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.submission1_submitdone"
    			ev:submiterror="scwin.submission1_submiterror" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_getClaimData" action="/InsWebApp/getClaimData.pwkjson" method="post" mediatype="application/json" ref=''
    			target='data:json,{"id":"dma_claimData","key":"elData"}' encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
    			mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getClaimData_submitdone" ev:submiterror="" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_submitFinalClaim" action="/InsWebApp/submitFinalClaim.pwkjson" method="post" mediatype="application/json"
    			ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
    			processMsg="청구서를 제출하고 있습니다..." ev:submit="" ev:submitdone="scwin.sbm_submitFinalClaim_submitdone"
    			ev:submiterror="scwin.sbm_submitFinalClaim_submiterror" abortTrigger="">
    		</xf:submission>
    		<xf:submission id="sbm_ClaimSaveDone" action="/InsWebApp/ClaimSaveDone.pwkjson" method="post" mediatype="application/json"
    			ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg=""
    			ev:submit="" ev:submitdone="scwin.sbm_ClaimSaveDone_submitdone" ev:submiterror="" abortTrigger="">
    		</xf:submission>
    	</xf:model>
    	<w2:leaf>true</w2:leaf>
    	<w2:fileName>final_check.xml</w2:fileName>
    	<w2:css src="/css/custom.css"></w2:css>
    	<w2:js src="/js/final_check.js"></w2:js>
    	<w2:engine-version>5.0.0</w2:engine-version>
        <script cache="false" scopeExternal="false" src="/InsWebApp/js/insure/sweet-alert.js" scopeVariable="" type="text/javascript"></script>
        <script lazy="false" type="text/javascript"><![CDATA[
scwin.onpageload = function() {
	//서버에 세션 데이터 요청하는 서브미션 실행
    $p.executeSubmission("sbm_getClaimData");
};

// 세션 데이터 조회 성공 시
scwin.sbm_getClaimData_submitdone = function (e) {

    console.log("서버로부터 받은 원본 응답:", e.responseJSON);
    
    var claimData = e.responseJSON.elData;

    console.log("claimData : ", claimData);


    if(!claimData || Object.keys(claimData).length === 0) {
        scwin.toastAlertMobile({
            icon:"청구 정보 조회 실패",
            title: errorMessage
        });

        return;
    }

    // 1. 청구 정보 채우기
    var claimTypeKorean = claimData.claimType === 'disease' ? '질병' : '재해';
    claimTypeValue.setLabel(claimTypeKorean || "정보 없음");
    accidentDateValue.setLabel(scwin.formatDate(claimData.accidentDate) || "정보 없음");

    // 2. 진단 내용 채우기
    symptomValue.setLabel(claimData.symptom || "정보 없음");

    // 3. 계좌 정보 채우기
    bankNameValue.setLabel(claimData.bankName || "정보 없음");
    accountNoValue.setLabel(claimData.accountNo || "정보 없음");
    accountHolderValue.setLabel(claimData.accountHolder || "정보 없음");

    // 4. 개인정보 동의 여부 채우기
    consentValue.setLabel(claimData.agreed ? "동의함" : "정보 없음");

    // 5. 청구 서류 이미지 표시
    var attachmentBox = document.querySelector('[id$="attachmentBox"]');
    if (claimData.s3fileUrls && claimData.s3fileUrls.length > 0 ) {
        var allImagesHTML = "";
        claimData.s3fileUrls.forEach(function(url) {
                allImagesHTML += '<img src="' + url + '"style="width:100%; height:100px; border-radius:8px; object-fit:cover;">';
            });
            attachmentBox.innerHTML = allImagesHTML;
    } else {
        attachmentBox.innerHTML = "<span>서류 없음</span>";
    }
};


scwin.dataURItoBlob = function(dataURI){
    var byteString = atob(dataURI.split(',')[1]);
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++){
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab],{type:mimeString});
};

scwin.btnNext_onclick = function () {
    if (confirm("입력하신 내용으로 보험금을 청구하시겠습니까?")) {
        $p.executeSubmission("sbm_submitFinalClaim");
    }
};


scwin.submission1_submitdone = function (e) {
    console.log("개별 서류 접수 성공: ", e);
};

scwin.submission1_submiterror = function (e) {
    console.error("개별 서류 접수 실패: ", e);
};

scwin.formatDate = function(dateStr) {
    if (!dateStr || dateStr.length !== 8) {
        return "정보 없음";
    }
    var year = dateStr.substring(0, 4);
    var month = parseInt(dateStr.substring(4, 6), 10);
    var day = parseInt(dateStr.substring(6, 8), 10);
    return year + "년 " + month + "월 " + day + "일";
};


scwin.btn_edit_symptom_onclick = function (e) {
    // 수정모드 파라미터 전달하며 페이지 이동
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/third.xml&mode=edit";
};

scwin.btn_edit_claimType_onclick = function (e) {
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/first.xml&mode=edit";
};

scwin.btn_edit_accidentDate_onclick = function (e) {
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/second.xml&mode=edit";
};

scwin.btn_edit_account_onclick = function (e) {
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/fourth2.xml&mode=edit";
};

scwin.btn_edit_docs_onclick = function (e) {
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/fifth2.xml&mode=edit";
};

scwin.sbm_submitFinalClaim_submitdone = function (e) {
    $p.executeSubmission("sbm_ClaimSaveDone");
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/claimMobile/last.xml";
};

scwin.sbm_submitFinalClaim_submiterror = function (e) {
    var errorMessage = e.responseJSON.elHeader.resMsg;
    scwin.toastAlertMobile({
        icon:"error",
        title: errorMessage
    });
};

scwin.sbm_ClaimSaveDone_submitdone = function (e) {
    console.log("후속처리",e);
    
    
};
]]></script>
        <style type="text/css"><![CDATA[/* custom.css */

/*
  ======================================
  Common Styles
  ======================================
*/
.pageWrapper {
    font-family: 'Malgun Gothic', 'Dotum', sans-serif;
    background-color: #f7f7f7;
}

/* Header and Progress Bar */
.pageWrapper > xf\:group:first-child > xf\:group:first-child {
    background-color: #ffffff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

#progressBar {
    height: 100%;
    background-color: #ffc107;
    transition: width 0.5s ease-in-out;
}

.stepIndicatorContainer {
    padding-top: 10px;
}

.progressBtn {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 2px solid #ccc;
    background-color: #fff;
    color: #ccc;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    cursor: default;
}

.progressBtn.completed {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #fff;
}

.progressBtn.active {
    background-color: #fff;
    border-color: #ffc107;
    color: #ffc107;
}

/* Scrollable Main Content Wrapper */
#mainContentWrapper {
    flex: 1; /* Take up all remaining space */
    overflow-y: auto; /* Enable vertical scrolling */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

/* Section titles */
.sectionTitle {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

/* Info Box */
.infoBox {
    width: 100%;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Info Row for key-value pairs */
.infoRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.infoLabel {
    font-weight: bold;
    color: #555;
    flex-shrink: 0;
    margin-right: 15px;
}

.infoValue {
    font-weight: 500;
    color: #222;
    text-align: right;
}

/* Text Button (e.g., '수정') */
.textButton {
    background-color: transparent;
    border: none;
    color: #888;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}

/* Selection Buttons (e.g., '네/아니오') */
.selectionBtn {
    background-color: #fff;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    cursor: pointer;
}

.selectionBtn:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.selectionBtn.selected {
    border-color: #ffc107;
    background-color: #fff8e1;
}

.selectionBtn.half {
    flex: 1;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
}

/* Fixed Bottom Button */
.nextBtn {
    width: 100%;
    height: 65px;
    background-color: #ffc107;
    border-radius: 35px;
    color: white;
    font-size: 22px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: background-color 0.2s;
}

.nextBtn:hover {
    background-color: #ffb300;
}

/* Scroll to Top button */
#scrollTopBtn {
    z-index: 100; /* Ensure it's on top */
    cursor: pointer;
}

/* Icon Styles (You must provide the actual image paths) */
.icon {
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}
.questionIcon { background-image: url('/images/question_icon.png'); width: 16px; height: 16px; }
.arrowUpIcon { background-image: url('/images/arrow_up_icon.png'); }]]></style>
    </head>
    <body ev:onpageload="scwin.onpageload">
        <w2:wframe src="/InsWebApp/ui/cmmn/m_header_claim.xml" style="" id="" class="wfm_m_header"></w2:wframe>
        <xf:group class="sub_contents2" id="wrapper" style="">
            <xf:group class="header-section" id="header" style="">
                <w2:textbox class="step_tit" id="" label="최종확인" style="" tagname=""></w2:textbox>
                <xf:group class="step" id="" style="">
                    <xf:group id="" style="" tagname="ul">
                        <xf:group class="inactive" id="" style="" tagname="li"><w2:span id="" label="✔" style=""></w2:span></xf:group>
                        <xf:group class="inactive" id="" style="" tagname="li"><w2:span id="" label="✔" style=""></w2:span></xf:group>
                        <xf:group class="inactive" id="" style="" tagname="li"><w2:span id="" label="✔" style=""></w2:span></xf:group>
                        <xf:group class="inactive" id="" style="" tagname="li"><w2:span id="" label="✔" style=""></w2:span></xf:group>
                        <xf:group class="inactive" id="" style="" tagname="li"><w2:span id="" label="✔" style=""></w2:span></xf:group>
                        <xf:group class="current" id="" style="" tagname="li"><w2:span id="" label="6" style=""></w2:span></xf:group>
                        <xf:group class="inactive" id="" style="" tagname="li"><w2:span id="" label="7" style=""></w2:span></xf:group>
                    </xf:group>
                </xf:group>
            </xf:group>

            <xf:group class="content-section" id="mainContent" style="margin:0 auto;">
                <w2:textbox class="question-text" id="" label="신청 내용을 확인해 주세요" style=""></w2:textbox>
                
                <xf:group class="infoSection">
                    <xf:group style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <w2:span label="청구 정보" class="sectionTitle"></w2:span>
                        <xf:trigger type="button" class="textButton" id="btn_edit_claimType" ev:onclick="scwin.btn_edit_claimType_onclick">
                            <xf:label>수정</xf:label>
                        </xf:trigger>
                    </xf:group>
                    <xf:group class="infoBox">
                        <xf:group class="infoRow">
                            <w2:span label="청구 사유" class="infoLabel"></w2:span>
                            <w2:span id="claimTypeValue" label="질병" class="infoValue"></w2:span>
                        </xf:group>
                    </xf:group>
                </xf:group>

                <xf:group class="infoSection">
                    <xf:group style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <w2:span label="사고 정보" class="sectionTitle"></w2:span>
                        <xf:trigger type="button" class="textButton" id="btn_edit_accidentDate" ev:onclick="scwin.btn_edit_accidentDate_onclick">
                            <xf:label>수정</xf:label>
                        </xf:trigger>
                    </xf:group>
                    <xf:group class="infoBox">
                        <xf:group class="infoRow">
                            <w2:span label="사고(발병)일" class="infoLabel"></w2:span>
                            <w2:span id="accidentDateValue" label="2025-07-15" class="infoValue"></w2:span>
                        </xf:group>
                    </xf:group>
                </xf:group>

                <xf:group class="infoSection">
                    <xf:group style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <w2:span label="진단 내용" class="sectionTitle"></w2:span>
                        <xf:trigger type="button" class="textButton" id="btn_edit_symptom" ev:onclick="scwin.btn_edit_symptom_onclick">
                            <xf:label>수정</xf:label>
                        </xf:trigger>
                    </xf:group>
                    
                    <xf:group class="infoBox" style="padding: 20px;">
                        <w2:span id="symptomValue" label="고객이 입력한 상세 진단 내용이 여기에 표시됩니다." style="line-height: 1.5;"></w2:span>
                    </xf:group>
                </xf:group>

                <xf:group class="infoSection">
                    <xf:group style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <w2:span label="보험금 받을 계좌" class="sectionTitle"></w2:span>
                        <xf:trigger type="button" class="textButton" id="btn_edit_account" ev:onclick="scwin.btn_edit_account_onclick">
                            <xf:label>수정</xf:label>
                        </xf:trigger>
                    </xf:group>
                    <xf:group class="infoBox">
                        <xf:group class="infoRow">
                            <w2:span label="은행" class="infoLabel"></w2:span>
                            <w2:span id="bankNameValue" label="KB국민은행" class="infoValue"></w2:span>
                        </xf:group>
                        <xf:group class="infoRow">
                            <w2:span label="계좌번호" class="infoLabel"></w2:span>
                            <w2:span id="accountNoValue" label="123456-78-901234" class="infoValue"></w2:span>
                        </xf:group>
                        <xf:group class="infoRow">
                            <w2:span label="예금주" class="infoLabel"></w2:span>
                            <w2:span id="accountHolderValue" label="홍길동" class="infoValue"></w2:span>
                        </xf:group>
                    </xf:group>
                </xf:group>

                <xf:group class="infoSection">
                    <xf:group style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <w2:span label="청구서류" class="sectionTitle"></w2:span>
                        <xf:trigger type="button" class="textButton" id="btn_edit_docs" ev:onclick="scwin.btn_edit_docs_onclick">
                            <xf:label>수정</xf:label>
                        </xf:trigger>
                    </xf:group>
                    <xf:group class="infoBox" id="attachmentBox" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px;">
                        </xf:group>
                </xf:group>

                <xf:group class="infoSection">
                    <w2:span label="개인정보 처리 동의" class="sectionTitle" style="margin-bottom: 10px;"></w2:span>
                    <xf:group class="infoBox">
                        <xf:group class="infoRow">
                            <w2:span label="개인(신용)정보 처리" class="infoLabel"></w2:span>
                            <w2:span id="consentValue" label="동의함" class="infoValue" style="color: blue; font-weight: bold;"></w2:span>
                        </xf:group>
                    </xf:group>
                </xf:group>
                
            </xf:group>

            <xf:group style="height: 50px;"></xf:group>

            <xf:group class="footer-section" id="footer" style="">
                <w2:button class="next-button" id="btnNext" label="청구" ev:onclick="scwin.btnNext_onclick"></w2:button>
            </xf:group>
        </xf:group>
    </body>
</html>