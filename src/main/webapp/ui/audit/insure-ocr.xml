<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/InsWebApp/css/table.css" type="text/css"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
        	<w2:dataCollection baseNode="map">
        		<w2:dataMap baseNode="map" id="dm_sub">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="진료비총액" id="total_medical_fee"></w2:key>
        				<w2:key dataType="text" name="환자부담총액" id="total_patient_payment"></w2:key>
        				<w2:key dataType="text" name="이미납부한금액" id="amount_paid"></w2:key>
        				<w2:key dataType="text" name="납부할금액" id="due_amt"></w2:key>
        				<w2:key dataType="text" name="납부한금액" id="due_pay"></w2:key>
        				<w2:key dataType="text" name="진료id" id="treatment_id"></w2:key>
        				<w2:key dataType="text" name="청구번호" id="claim_no"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_result">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="최종수납액" id="final_due"></w2:key>
        				<w2:key dataType="text" name="병원공제금" id="hospital_prepaid"></w2:key>
        				<w2:key dataType="text" name="삭감항목금액" id="deducation_amt"></w2:key>
        				<w2:key dataType="text" name="산출금" id="refund_amt"></w2:key>
        				<w2:key dataType="text" name="진료id" id="treatment_id"></w2:key>
        				<w2:key dataType="text" name="청구번호" id="claim_no"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_getExc">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="청구번호" id="claim_no"></w2:key>
        				<w2:key dataType="text" name="진료ID" id="treatment_id"></w2:key>
        				<w2:key dataType="text" name="페이지_번호" id="pageIndex" defaultValue="1"></w2:key>
        				<w2:key defaultValue="100" dataType="text" name="페이지_건수" id="pageSize"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dl_excList" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column dataType="text" name="exc_id" id="exc_id"></w2:column>
        				<w2:column dataType="text" name="item_id" id="item_id"></w2:column>
        				<w2:column dataType="text" name="treatment_id" id="treatment_id"></w2:column>
        				<w2:column dataType="text" name="claim_no" id="claim_no"></w2:column>
        				<w2:column dataType="text" name="exc_reason" id="exc_reason"></w2:column>
        				<w2:column dataType="text" name="exc_cost" id="exc_cost"></w2:column>
        				<w2:column dataType="text" name="exc_category" id="exc_category"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dm_treatment">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="claim_no" id="claim_no"></w2:key>
        				<w2:key dataType="text" name="department" id="department"></w2:key>
        				<w2:key dataType="text" name="treatment_date" id="treatment_date"></w2:key>
        				<w2:key dataType="text" name="patient_type" id="patient_type"></w2:key>
        				<w2:key dataType="text" name="hospital_name" id="hospital_name"></w2:key>
        				<w2:key dataType="text" name="hospital_grade" id="hospital_grade"></w2:key>
        				<w2:key dataType="text" name="treatment_id" id="treatment_id"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dl_claimItemList" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column dataType="text" name="treatment_id" id="treatment_id"></w2:column>
        				<w2:column dataType="text" name="claim_no" id="claim_no"></w2:column>
        				<w2:column dataType="text" name="item_name" id="item_name"></w2:column>
        				<w2:column dataType="text" name="patient_amt" id="patient_amt"></w2:column>
        				<w2:column dataType="text" name="insur_amt" id="insur_amt"></w2:column>
        				<w2:column dataType="text" name="full_amt" id="full_amt"></w2:column>
        				<w2:column dataType="text" name="select_fee" id="select_fee"></w2:column>
        				<w2:column dataType="text" name="select_disc" id="select_disc"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dm_header">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="청구번호" id="claimNo"></w2:key>
        				<w2:key dataType="text" name="피보험자" id="patient"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_getTreatReq">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="claim_no" id="claim_no"></w2:key>
        				<w2:key dataType="text" name="treatment_date" id="treatment_date"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_getClaimItemList">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="search_treatment_id" id="SC_treatment_id"></w2:key>
        				<w2:key dataType="text" name="search_claim_no" id="SC_claim_no"></w2:key>
        				<w2:key dataType="text" name="페이지_번호" id="pageIndex" defaultValue="1"></w2:key>
        				<w2:key dataType="text" name="페이지_건수" id="pageSize" defaultValue="100"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dm_getTreatOnlyCno">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="SC_claim_no" id="SC_claim_no"></w2:key>
        				<w2:key dataType="text" name="pageSize" id="pageSize" defaultValue="100"></w2:key>
        				<w2:key dataType="text" name="pageIndex" id="pageIndex" defaultValue="1"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dl_treatmentList" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column dataType="text" name="claim_no" id="claim_no"></w2:column>
        				<w2:column dataType="text" name="department" id="department"></w2:column>
        				<w2:column dataType="text" name="treatment_date" id="treatment_date"></w2:column>
        				<w2:column dataType="text" name="patient_type" id="patient_type"></w2:column>
        				<w2:column dataType="text" name="hospital_name" id="hospital_name"></w2:column>
        				<w2:column dataType="text" name="hospital_grade" id="hospital_grade"></w2:column>
        				<w2:column dataType="text" name="treatment_id" id="treatment_id"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        	</w2:dataCollection>
        	<w2:workflowCollection />
        	<xf:submission id="sbm_getExcList" action="/InsWebApp/EXCITEMListR.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_getExc","key":"elData"}' target='data:json,{"id":"dl_excList","key":"excItemVoList"}' encoding="UTF-8"
        		instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="scwin.sbm_getExcList_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_insertSettlement" action="/InsWebApp/SETTLEMENTIns.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_result","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_insertPaymentInfo" action="/InsWebApp/PAYMENTINFOIns.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_sub","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_insertClaimItems" action="/InsWebApp/CLAIMITEMIns.pwkjson" method="post" mediatype="application/json"
        		ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg=""
        		ev:submit="" ev:submitdone="scwin.sbm_updateClaimItems_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getClaimItemList" action="/InsWebApp/CLAIMITEMList.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_getClaimItemList","key":"elData"}' target='data:json,{"id":"dl_claimItemList","key":"claimItemVoList"}'
        		encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="scwin.sbm_getClaimItemList_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getSettlement" action="/InsWebApp/SETTLEMENTUpdView.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_getExc","key":"elData"}' target='data:json,{"id":"dm_result","key":"elData"}' encoding="UTF-8"
        		instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone=""
        		ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getPaymentInfo" action="/InsWebApp/PAYMENTINFOUpdView.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_getExc","key":"elData"}' target='data:json,{"id":"dm_sub","key":"elData"}' encoding="UTF-8" instance=""
        		replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror=""
        		abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_insertTreatment" action="/InsWebApp/TREATMENTIns.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_treatment","key":"elData"}' target='' encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_insertTreatment_submitdone"
        		ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getTreatment" action="/InsWebApp/TREATMENTUpdView.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_getTreatReq","key":"elData"}' target='data:json,{"id":"dm_treatment","key":"elData"}' encoding="UTF-8"
        		instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="로딩 중..." ev:submit=""
        		ev:submitdone="scwin.sbm_getTreatment_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_updateTreatment" action="/InsWebApp/TREATMENTUpd.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_treatment","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="저장 중..." ev:submit="" ev:submitdone="scwin.sbm_insertTreatment_submitdone"
        		ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_updatePaymentInfo" action="/InsWebApp/PAYMENTINFOUpd.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_sub","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_updateClaimItems" action="/InsWebApp/CLAIMITEMUpd.pwkjson" method="post" mediatype="application/json"
        		ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg=""
        		ev:submit="" ev:submitdone="scwin.sbm_updateClaimItems_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_updateSettlement" action="/InsWebApp/SETTLEMENTUpd.pwkjson" method="post" mediatype="application/json"
        		ref='data:json,{"id":"dm_result","key":"elData"}' target="" encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getTreatmentOnlyCNo" action="/InsWebApp/TREATMENTList.pwkjson" method="post" mediatype="application/json" ref='data:json,{"id":"dm_getTreatOnlyCno","key":"elData"}' target='data:json,{"id":"dl_treatmentList","key":"elData.treatmentVoList"}'
        		encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="scwin.sbm_getTreatmentOnlyCNo_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        <script cache="false" scopeExternal="false" src="/InsWebApp/js/insure/ocr-table.js" scopeVariable="" type="text/javascript"></script>
        <script cache="false" scopeExternal="false" src="/InsWebApp/js/insure/ocr-tableStruc.js" scopeVariable="" type="text/javascript"></script>
        <script cache="false" scopeExternal="false" src="/InsWebApp/js/insure/dummy-table.js" scopeVariable="" type="text/javascript"></script>
        <script cache="false" scopeExternal="false" src="/InsWebApp/js/insure/sweet-alert.js" scopeVariable="" type="text/javascript"></script>
        <script lazy="false" type="text/javascript"><![CDATA[
scwin.onpageload = function() {
    scwin.emp = JSON.parse(localStorage.getItem("employee"));
    scwin.claim = JSON.parse(localStorage.getItem("claim"));
    scwin.isEmp = true;
    loadingScreen.hide();

    // 담당자 아니면 readonly
    if (scwin.emp.empNo != scwin.claim.empNo ||(
        scwin.claim.status != "결재반려" &&
        scwin.claim.status != "대기" &&
        scwin.claim.status != "보완완료" )) {
        scwin.isEmp = false;

        btn_ocr.hide();
        sel_department.setReadOnly(true);
        sel_hospitalName.setReadOnly(true);
        sel_hospital.setReadOnly(true);
        sel_patient.setReadOnly(true);

        ipt_paid.setReadOnly(true);
        ipt_willpay.setReadOnly(true);
        ipt_pay.setReadOnly(true);
    }

    if (scwin.claim.status === "결재반려") {
        btn_ocr.setDisabled(true);
    }

    var jsnOptions = {
        id: "img_popup",
        type: "browserPopup", //필수 고정
        width: "1000px",
        height: "800px",
        popupName: "청구 영수증"
    };

    $p.openPopup("/InsWebApp/ui/audit/img_modal.xml", jsnOptions);

    dm_header.set("claimNo", scwin.claim.claimNo);
    dm_header.set("patient", scwin.claim.userName);

    scwin.exclusionData = {};
    scwin.treatmentId = 0;
    scwin.isEdit = false; // false > insert | true > update
    scwin.nextClick = false;
    scwin.isGetTreatId = false; // insert 끝내고 treatmentId 가져오기.......


    if (scwin.isEmp && scwin.claim.status != "결재반려") {
        let savedData = JSON.parse(localStorage.getItem('dateList') || '[]');
        savedData.forEach(item => {
            date_drop.addItem(item.imgIdx, item.dateRange);
        });
        date_drop.setSelectedIndex(0);

        getTreatmentWithDate();

    } else { // 담당자 아니면
        dm_getTreatOnlyCno.set("SC_claim_no", scwin.claim.claimNo);
        $c.sbm.execute(sbm_getTreatmentOnlyCNo);
    }
    
};

function getTreatmentWithDate() {
    dm_treatment.set("treatment_date", date_drop.getText());
    
    if (scwin.isEmp && scwin.claim.status != "결재반려") { // 담당자
        scwin.claimImg = JSON.parse(localStorage.getItem("claimImg"));
        scwin.imgUrl = scwin.claimImg[date_drop.getValue()-1].imgSrc;
    }
        
    scwin.createEmptyTable();
    getInsure();
}

scwin.sbm_getTreatmentOnlyCNo_submitdone = function (e) {

    if (dl_treatmentList.getTotalRow() != 0) {
        var rowCount = dl_treatmentList.getRowCount();
        for (var i = 0; i < rowCount; i++) {
            var treatmentDate = dl_treatmentList.getCellData(i, "treatment_date");
            date_drop.addItem(i, treatmentDate); 
        }
        date_drop.setSelectedIndex(0);

        getTreatmentWithDate();

    } else { // db에도 없으면 그냥 빈테이블
        scwin.createEmptyTable();
    }
    
};

function getInsure() {
    // 가져오고
    dm_getTreatReq.set("claim_no", scwin.claim.claimNo);
    dm_getTreatReq.set("treatment_date", date_drop.getText());
    dm_treatment.set("treatment_date", date_drop.getText());
    $c.sbm.execute(sbm_getTreatment);
}

scwin.sbm_getTreatment_submitdone = function (e) {

    if (scwin.isGetTreatId) {
        localStorage.setItem("treatmentId", dm_treatment.getJSON().treatment_id)
        scwin.treatmentId = localStorage.getItem("treatmentId");

        dm_result.set("claim_no", scwin.claim.claimNo);
        dm_result.set("treatment_id", scwin.treatmentId);
        scwin.isEdit ? $c.sbm.execute(sbm_updateSettlement) : $c.sbm.execute(sbm_insertSettlement);

        dm_sub.set("claim_no", scwin.claim.claimNo);
        dm_sub.set("treatment_id", scwin.treatmentId);
        scwin.isEdit ? $c.sbm.execute(sbm_updatePaymentInfo) : $c.sbm.execute(sbm_insertPaymentInfo);

        let requestData = extractClaimItemData(scwin.treatmentId, scwin.claim.claimNo);
        requestData.forEach(item => {
            // item마다 저장 요청 실행
            scwin.isEdit ? $c.sbm.execute(sbm_updateClaimItems, {"elData": item}) : $c.sbm.execute(sbm_insertClaimItems, {"elData": item});
        });
        scwin.isGetTreatId = false;
        return;
    }

    // 값이 있으면 수정
    if (sel_department.getValue() !== "") {
        localStorage.setItem("treatmentId", dm_treatment.getJSON().treatment_id)
        scwin.treatmentId = localStorage.getItem("treatmentId");

        scwin.isEdit = true;

        dm_getExc.set("claim_no", scwin.claim.claimNo);
        dm_getExc.set("treatment_id", scwin.treatmentId);

        // 다른 애들도 가져오기
        $c.sbm.execute(sbm_getSettlement);
        $c.sbm.execute(sbm_getPaymentInfo);

        dm_getClaimItemList.set("SC_claim_no", scwin.claim.claimNo)
        dm_getClaimItemList.set("SC_treatment_id", scwin.treatmentId);
        $c.sbm.execute(sbm_getClaimItemList);
        
        // 제외항목
        $c.sbm.execute(sbm_getExcList);
    } else {
        scwin.isEdit = false;
    }
};

scwin.sbm_getClaimItemList_submitdone = function (e) {
    const convertedList = dl_claimItemList.getAllJSON().map(item => ({
        col1: item.item_name,
        col2: item.patient_amt,
        col3: item.insur_amt,
        col4: item.full_amt,
        col5: item.select_fee,
        col6: item.select_disc
    }));

    // 테이블 만들기
    scwin.createTable(convertedList);
};

scwin.sbm_getExcList_submitdone = function (e) {
    let excArray = dl_excList.getAllJSON();
    let excTotal = 0;
    excArray.forEach(item => {
        if (item.item_id != null && item.exc_id != null && item.exc_cost !== undefined) {
            excTotal += Number(item.exc_cost);

            const key = `${item.item_id}_${item.exc_id}`;
            scwin.exclusionData[key] = item.exc_cost;

            scwin.updateExclusionCell(item.item_id, item.exc_id, item.exc_cost);
        }
    });

    ipt_excTotal.setValue(excTotal);
    localStorage.setItem("excTotal", excTotal);
    scwin.updateColumnTotal(3);
    scwin.updateColumnTotal(6);
};

scwin.updateExclusionCell = function(rowIndex, colIndex, newValue) {
    const mainTable = document.querySelector('#tableContainer table');
    if (!mainTable) return;

    const rows = mainTable.rows;
    const dataRowIndex = 3 + Number(rowIndex); // 헤더 3줄 제외
    const targetRow = rows[dataRowIndex];

    if (!targetRow) return;

    const cellIndex = targetRow.cells.length - 8 + Number(colIndex) + 1;
    const targetCell = targetRow.cells[cellIndex];
   
    if (!targetCell) return;

    // 값 반영
    targetCell.textContent = Number(newValue).toLocaleString();

    // 스타일 및 기타 표시 유지
    targetCell.style.backgroundColor = '#fff3cd';
    targetCell.style.cursor = 'pointer';

    scwin.updateColumnTotal(colIndex);
}

scwin.btn_ocr_onclick = function (e) {
    loadingScreen.show();
    loadingScreen.setStyle("display", "flex");

    // OCR 버튼 클릭 시 OCR 결과를 받아서 테이블을 동적으로 업데이트
    let formData = new FormData();
    formData.append("img_url", scwin.imgUrl);
    console.log(scwin.imgUrl);

    $.ajax({
        url: 'http://localhost:5000/ocr', //'http://localhost:8000/api/v1/insurance/ocr',
        type: 'POST',
        data: formData,
        contentType: false,  // multipart/form-data 자동 처리
        processData: false,  // FormData 객체를 문자열로 변환하지 않음
        success: function (response) {
            console.log(response.data);
            scwin.createTable(response.data);
        },
        error: function (xhr, status, error) {
            loadingScreen.hide();
            scwin.noBtnAlertWithTimer({
                title: 'OCR 인식에 실패했습니다', 
                icon: 'error'
            });
        },
        complete: function() {
            loadingScreen.hide();
        }
    }); 
};

scwin.btn_before_onclick = function (e) {
    // 이전 화면으로
    location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/audit/insure_second.xml"
};

scwin.date_drop_onchange = function (info) {
    // 바뀔 때 저장
    if (info.oldValue !== null) {
        saveInsure(info.oldValue);
    }
};

const Toast = Swal.mixin({
  toast: true,
  position: 'top-end',
  iconColor: 'white',
  showConfirmButton: false,
  timer: 1500,
  timerProgressBar: false,

})

function saveInsure(idx = -1) {
    if (!scwin.isEmp) {
        getInsure();
        return;
    }

    if (sel_hospital.getValue() && sel_department.getValue()&& sel_hospitalName.getValue() && sel_patient.getValue()) {
        dm_treatment.set("claim_no", scwin.claim.claimNo);

        scwin.imgUrl = scwin.claimImg[date_drop.getValue()-1].imgSrc;

        // todo: 이미지 모달.. setSrc

        scwin.isEdit ? $c.sbm.execute(sbm_updateTreatment) : $c.sbm.execute(sbm_insertTreatment);
    }
    else {
        date_drop.setEventPause("onchange", true);
        scwin.noBtnAlertWithTimer({
            title: '진료 정보 입력을 확인하세요', 
            text: '병원명/진료과, 병원등급, 환자등급', 
            icon: 'warning'
        });
        date_drop.setSelectedIndex(idx - 1);
        date_drop.setEventPause("onchange", false);
    }
}

scwin.sbm_insertTreatment_submitdone = function (e) {
    scwin.isGetTreatId = true;
    $c.sbm.execute(sbm_getTreatment);
};

scwin.sbm_updateClaimItems_submitdone = function (e) {

    if (scwin.nextClick) {
        localStorage.removeItem("excTotal");
        localStorage.removeItem("exc");
        localStorage.removeItem("treatmentId");
        
        //location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/audit/insure-result.xml";
        return;
    }

    // 초기화
    dm_treatment.setEmptyValue();
    dm_result.setEmptyValue();
    dm_sub.setEmptyValue();
    
    dl_excList.setJSON({});
    scwin.exclusionData = {}; 

    scwin.createEmptyTable();
    resetExclusionCells(); 

    localStorage.removeItem("treatmentId");
    
    getInsure();
};

function resetExclusionCells() {
    const mainTable = document.querySelector('#tableContainer table');
    if (!mainTable) return;

    const rows = mainTable.rows;

    for (let i = 3; i < rows.length; i++) { // 데이터 행
        for (let colIdx of [3, 6]) { // 제외항목 열 index (colIndex: 3=col5, 6=col8)
            scwin.updateExclusionCell(i - 3, colIdx, 0);
        }
    }

    // 합계도 다시 계산
    ipt_excTotal.setValue(0);
    scwin.updateColumnTotal(3);
    scwin.updateColumnTotal(6);
}

scwin.btn_next_onclick = function (e) {
    scwin.nextClick = true;
    if (scwin.isEmp) {
        saveInsure();
    } else {
        location.href = "/InsWebApp/websquare/websquare.html?w2xPath=/InsWebApp/ui/audit/insure-result.xml";
    }
    $p.closePopup("img_popup");
};

scwin.ipt_paid_onchange = function (info) {
    setTotalPay();
};

scwin.ipt_pay_onchange = function (info) {
    setTotalPay();
};

function setTotalPay() {
    let total = Number(ipt_pay.getValue()) + Number(ipt_paid.getValue());
    ipt_fianlpay.setValue(total);

    calcuResultTableTotal();
}

scwin.sel_hospital_onchange = function (info) {
    ipt_hosp.setValue(0);
    let hospital_prepaid = info.newValue === "1" ? 10000 : info.newValue === "2" ? 15000 : 20000;
    ipt_hosp.setValue(hospital_prepaid);

    calcuResultTableTotal();
};

// result table 산출금 계산 
function calcuResultTableTotal() {
    let value = Number(ipt_fianlpay.getValue()) - Number(ipt_excTotal.getValue()) - Number(ipt_hosp.getValue());
    ipt_result.setValue(value);
}

scwin.ipt_excTotal_onchange = function (info) {
    calcuResultTableTotal();
};

function extractClaimItemData(treatmentId, claimNo) {
    const table = document.querySelector('#tableContainer table');
    const data = [];
    if (!table) return data;

    const rows = table.rows;

    for (let i = 3; i < rows.length; i++) { // 헤더 3행 제외
        const row = rows[i];
        const cells = row.cells;
        const itemName = cells[cells.length - 8]?.textContent.trim();
        if (!itemName) continue;

        // DB insert용 객체 생성
        const item = {
            item_id: i - 3, // row number
            treatment_id: treatmentId,
            claim_no: claimNo,
            item_name: itemName,
            patient_amt: parseFloat(cells[cells.length - 7]?.textContent.replace(/,/g, '') || 0),  // col2
            insur_amt:   parseFloat(cells[cells.length - 6]?.textContent.replace(/,/g, '') || 0),  // col3
            full_amt:    parseFloat(cells[cells.length - 5]?.textContent.replace(/,/g, '') || 0),  // col4
            select_fee:  parseFloat(cells[cells.length - 3]?.textContent.replace(/,/g, '') || 0),  // col6
            select_disc: parseFloat(cells[cells.length - 2]?.textContent.replace(/,/g, '') || 0),  // col7
        };

        data.push(item);
    }

    return data;
}

]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">
        <xf:group id="loadingScreen" style="background-color: rgba(0, 0, 0, 0.5);display: none;" class="loading-overlay">

        	<xf:group style="background-color: transparent;" id="" class="loading-spinner"></xf:group>
        </xf:group>
        <w2:wframe style="z-index: 20;top: 0;width: 100%;" id="" src="/InsWebApp/ui/cmmn/header.xml"></w2:wframe>
        <xf:group class="sub_contents">
        	<xf:group class="pgtbox" style="justify-content: space-between;">
        		<xf:group style="display: flex;" id="">
        			<w2:textbox ref="" label="청구번호: " class="pgt_tit"></w2:textbox>
        			<w2:textbox ref="data:dm_header.claimNo" style="padding-left: 10px;" id="" label="" class="pgt_tit"></w2:textbox>
        		</xf:group>
        		<xf:group style="display: flex;" id="">
        			<w2:textbox style="float: right;;" label="피보험자: " class="pgt_tit"></w2:textbox>
        			<w2:textbox id="" label="" style="padding-left: 10px;" ref="data:dm_header.patient" class="pgt_tit"></w2:textbox>
        		</xf:group>
        	</xf:group>
        	<xf:group meta_snippetCategory="03_조회영역" meta_snippetName="3_02 조회조건2행" meta_snippetKeyComponent="true" style="" id=""
        		class="schbox">
        		<xf:group style="" id="" class="schbox_inner">
        			<xf:group adaptive="layout" adaptiveThreshold="768" tagname="table" style="" id="" class="w2tb tbl ">
        				<w2:attributes>
        					<w2:summary></w2:summary>
        				</w2:attributes>
        				<xf:group tagname="colgroup">
        					<xf:group tagname="col" style="width:100px;"></xf:group>
        					<xf:group tagname="col" style=""></xf:group>
        					<xf:group tagname="col" style="width:100px;"></xf:group>
        					<xf:group tagname="col" style=""></xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="" id="" class="">
        					<xf:group tagname="th" style="" class="w2tb_th">
        						<w2:textbox style="" id="" label="입통원일자" class=""></w2:textbox>
        					</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:select1 submenuSize="auto" ev:onchange="scwin.date_drop_onchange" chooseOption="" allOption="" ref=""
        							appearance="minimal" disabledClass="w2selectbox_disabled" disabled="false" style="width:150px;text-align: center;" id="date_drop" renderType=""
        							class="" direction="auto">
        							<xf:choices></xf:choices>
        						</xf:select1>
        					</xf:group>
        					<xf:group tagname="th" style="" class="w2tb_th">
        						<w2:textbox style="" id="" label="병원명/진료과" class="req"></w2:textbox>
        					</xf:group>
        					<xf:group tagname="td" style="" id="" class="w2tb_td">
        						<xf:select1 allOption="" appearance="minimal" chooseOption="true" chooseOptionLabel="선택" direction="auto"
        							disabled="false" disabledClass="w2selectbox_disabled" id="sel_hospitalName" ref="data:dm_treatment.hospital_name"
        							style="width:150px;" submenuSize="auto">
        							<xf:choices>
        								<xf:item>
        									<xf:label><![CDATA[고려대학교 안암병원]]></xf:label>
        									<xf:value><![CDATA[고려대학교 안암병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[코코이비인후과의원]]></xf:label>
        									<xf:value><![CDATA[코코이비인후과의원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[경희대학교병원]]></xf:label>
        									<xf:value><![CDATA[경희대학교병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[정의원]]></xf:label>
        									<xf:value><![CDATA[정의원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[빈센트치과의원]]></xf:label>
        									<xf:value><![CDATA[빈센트치과의원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[서울대학교병원]]></xf:label>
        									<xf:value><![CDATA[서울대학교병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[서울대학교어린이병원]]></xf:label>
        									<xf:value><![CDATA[서울대학교어린이병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[서울대학교암병원]]></xf:label>
        									<xf:value><![CDATA[서울대학교암병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[서울대학교치과병원]]></xf:label>
        									<xf:value><![CDATA[서울대학교치과병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[연세소아청년과의원]]></xf:label>
        									<xf:value><![CDATA[연세소아청년과의원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[애플산부인과의원]]></xf:label>
        									<xf:value><![CDATA[애플산부인과의원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[포레스트병원]]></xf:label>
        									<xf:value><![CDATA[포레스트병원]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[홍성의료원]]></xf:label>
        									<xf:value><![CDATA[홍성의료원]]></xf:value>
        								</xf:item>
        							</xf:choices>
        						</xf:select1>
        						<xf:select1 allOption="" appearance="minimal" chooseOption="true" chooseOptionLabel="선택" direction="auto"
        							disabled="false" disabledClass="w2selectbox_disabled" id="sel_department" ref="data:dm_treatment.department"
        							style="width:150px;" submenuSize="auto">
        							<xf:choices>
        								<xf:item>
        									<xf:label><![CDATA[순환기내과]]></xf:label>
        									<xf:value><![CDATA[순환기내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[피부과]]></xf:label>
        									<xf:value><![CDATA[피부과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[안과]]></xf:label>
        									<xf:value><![CDATA[안과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[호흡기내과]]></xf:label>
        									<xf:value><![CDATA[호흡기내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[소화기내과]]></xf:label>
        									<xf:value><![CDATA[소화기내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[혈액종양내과]]></xf:label>
        									<xf:value><![CDATA[혈액종양내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[내분비대사내과]]></xf:label>
        									<xf:value><![CDATA[내분비대사내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[알레르기내과]]></xf:label>
        									<xf:value><![CDATA[알레르기내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[신장내과]]></xf:label>
        									<xf:value><![CDATA[신장내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[감염내과]]></xf:label>
        									<xf:value><![CDATA[감염내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[류마티스내과]]></xf:label>
        									<xf:value><![CDATA[류마티스내과]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[내과(일반)]]></xf:label>
        									<xf:value><![CDATA[내과(일반)]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[내과(입원의학)]]></xf:label>
        									<xf:value><![CDATA[내과(입원의학)]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[응급의학]]></xf:label>
        									<xf:value><![CDATA[응급의학]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[치과]]></xf:label>
        									<xf:value><![CDATA[치과]]></xf:value>
        								</xf:item>
        							</xf:choices>
        						</xf:select1>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="" id="" class="">
        					<xf:group tagname="th" style="" class="w2tb_th">
        						<w2:textbox style="" id="" label="병원등급" class=""></w2:textbox>
        					</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:select1 submenuSize="auto" ref="data:dm_treatment.hospital_grade" appearance="minimal"
        							ev:onchange="scwin.sel_hospital_onchange" disabledClass="w2selectbox_disabled" chooseOption="true" style="width:150px;"
        							disabled="false" id="sel_hospital" allOption="" direction="auto" chooseOptionLabel="선택">
        							<xf:choices>
        								<xf:item>
        									<xf:label><![CDATA[의원급]]></xf:label>
        									<xf:value><![CDATA[1]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[병원급]]></xf:label>
        									<xf:value><![CDATA[2]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[상급종합병원급]]></xf:label>
        									<xf:value><![CDATA[3]]></xf:value>
        								</xf:item>
        							</xf:choices>
        						</xf:select1>
        					</xf:group>
        					<xf:group tagname="th" style="" class="w2tb_th">
        						<w2:textbox style="" id="" label="환자구분" class=""></w2:textbox>
        					</xf:group>
        					<xf:group tagname="td" style="" id="" class="w2tb_td">
        						<xf:select1 allOption="" appearance="minimal" chooseOption="true" chooseOptionLabel="선택" direction="auto"
        							disabled="false" disabledClass="w2selectbox_disabled" id="sel_patient"
        							ref="data:dm_treatment.patient_type" style="width:150px;" submenuSize="auto">
        							<xf:choices>
        								<xf:item>
        									<xf:label><![CDATA[국민공단]]></xf:label>
        									<xf:value><![CDATA[국민공단]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[일반]]></xf:label>
        									<xf:value><![CDATA[일반]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[산재]]></xf:label>
        									<xf:value><![CDATA[산재]]></xf:value>
        								</xf:item>
        								<xf:item>
        									<xf:label><![CDATA[자동차재해]]></xf:label>
        									<xf:value><![CDATA[자동차재해]]></xf:value>
        								</xf:item>
        							</xf:choices>
        						</xf:select1>
        					</xf:group>
        				</xf:group>
        			</xf:group>
        		</xf:group>
        		<xf:group style="" id="" class="btn_schbox">
        			<xf:trigger ev:onclick="scwin.btn_ocr_onclick" disabled="" style="" id="btn_ocr" type="button" class="btn_cm sch"
        				escape="false">
        				<xf:label><![CDATA[OCR]]></xf:label>
        			</xf:trigger>
        		</xf:group>
        	</xf:group>
        	<!-- 동적으로 테이블을 생성할 공간 -->
        	<xf:group style="width: 100%; display: flex;" id="">
        		<xf:group style="width: 70%;" id="">
        			<div style="" id="tableContainer"></div>
        		</xf:group>
        		<xf:group style="width: 30%; margin-left: 15px;" id="">
        			<xf:group tagname="table" style="width:100%;height: 100px;" id="" class="w2tb">
        				<w2:attributes>
        					<w2:summary></w2:summary>
        				</w2:attributes>
        				<xf:group tagname="caption"></xf:group>
        				<xf:group tagname="colgroup">
        					<xf:group tagname="col" style="width:50.00%;"></xf:group>
        					<xf:group tagname="col" style="width:50.00%;"></xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="height:30px;">
        					<xf:group tagname="th"
        						style="border:1px solid #ddd;padding:8px;background:#f2f2f2;text-align:center;width:50%;height: 30px;" class="w2tb_th">
        						구분
        						<w2:attributes>
        							<w2:scope>col</w2:scope>
        						</w2:attributes>
        					</xf:group>
        					<xf:group tagname="th"
        						style="border:1px solid #ddd;padding:8px;background:#f2f2f2;text-align:center;width:50%;height: 30px;" class="w2tb_th">
        						금액산정내용
        						<w2:attributes>
        							<w2:scope>col</w2:scope>
        						</w2:attributes>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">진료비총액</xf:group>
        					<xf:group tagname="td" style="" id="cell_total" class="w2tb_td">
        						<xf:input readOnlyClass="readonly" ref="data:dm_sub.total_medical_fee" style="width: 144px;height: 21px;"
        							readOnly="true" id="ipt_tableTotal" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">환자부담총액</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input readOnlyClass="readonly" ref="data:dm_sub.total_patient_payment"
        							style="width: 144px;height: 21px;" readOnly="true" id="ipt_tableTotalminus" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">이미납부한금액</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input ref="data:dm_sub.amount_paid" ev:onchange="scwin.ipt_paid_onchange" maxByteLength=""
        							dataType="text" style="width: 144px;height: 21px;" id="ipt_paid" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">납부할금액</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input ref="data:dm_sub.due_amt" maxByteLength="" dataType="text" style="width: 144px;height: 21px;"
        							id="ipt_willpay" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">납부한금액</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input ref="data:dm_sub.due_pay" ev:onchange="scwin.ipt_pay_onchange" maxByteLength="" dataType="text"
        							style="width: 144px;height: 21px;" id="ipt_pay" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        			</xf:group>
        			<xf:group tagname="table" style="width:100%;height: 100px;margin-top: 20px;" id="" class="w2tb">
        				<w2:attributes>
        					<w2:summary></w2:summary>
        				</w2:attributes>
        				<xf:group tagname="caption"></xf:group>
        				<xf:group tagname="colgroup">
        					<xf:group tagname="col" style="width:50.00%;"></xf:group>
        					<xf:group tagname="col" style="width:50.00%;"></xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="height:30px;">
        					<xf:group tagname="th"
        						style="border:1px solid #ddd;padding:8px;background:#f2f2f2;text-align:center;width:50%;height: 30px;" class="w2tb_th">
        						구분
        						<w2:attributes>
        							<w2:scope>col</w2:scope>
        						</w2:attributes>
        					</xf:group>
        					<xf:group tagname="th"
        						style="border:1px solid #ddd;padding:8px;background:#f2f2f2;text-align:center;width:50%;height: 30px;" class="w2tb_th">
        						금액산정내용
        						<w2:attributes>
        							<w2:scope>col</w2:scope>
        						</w2:attributes>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">최종수납액</xf:group>
        					<xf:group tagname="td" style="" id="" class="w2tb_td">
        						<xf:input ref="data:dm_result.final_due" readOnlyClass="readonly" style="width: 144px;height: 21px;"
        							readOnly="true" id="ipt_fianlpay" class="" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">병원공제금</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input ref="data:dm_result.hospital_prepaid" readOnlyClass="readonly" style="width: 144px;height: 21px;"
        							readOnly="true" id="ipt_hosp" class="readonly" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">삭감항목총액</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input ref="data:dm_result.deducation_amt" readOnlyClass="readonly"
        							ev:onchange="scwin.ipt_excTotal_onchange" style="width: 144px;height: 21px;" readOnly="true" id="ipt_excTotal"
        							class="readonly" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        				<xf:group tagname="tr" style="">
        					<xf:group tagname="td" style="" class="w2tb_td">산출금</xf:group>
        					<xf:group tagname="td" style="" class="w2tb_td">
        						<xf:input ref="data:dm_result.refund_amt" readOnlyClass="readonly" style="width: 144px;height: 21px;"
        							readOnly="true" id="ipt_result" class="readonly" initValue="0" displayFormat="##,###,###,###">
        						</xf:input>
        					</xf:group>
        				</xf:group>
        			</xf:group>
        			<xf:group meta_snippetCategory="08_버튼" meta_snippetName="8_04 전체제어버튼" meta_snippetKeyComponent="true" style="margin-top: 185px;" id=""
        				class="btnbox">
        				<xf:group style="" id="" class="rt">
        					<xf:trigger ev:onclick="scwin.btn_before_onclick" style="" id="btn_before" type="button" class="btn_cm">
        						<xf:label><![CDATA[이전]]></xf:label>
        					</xf:trigger>
        					<w2:textbox style="" id="" label="" class="bar_btndiv"></w2:textbox>
        					<xf:trigger ev:onclick="scwin.btn_next_onclick" style="" id="btn_next" type="button" class="btn_cm pt">
        						<xf:label><![CDATA[다음]]></xf:label>
        					</xf:trigger>
        				</xf:group>
        			</xf:group>
        		</xf:group>

        	</xf:group>
        </xf:group>
    </body>
</html>
