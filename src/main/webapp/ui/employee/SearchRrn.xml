<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/InsWebApp/cm/css/searchRnn.css" type="text/css"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
        	<w2:dataCollection baseNode="map">
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_request_list" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column dataType="text" name="청구번호" id="claim_no"></w2:column>
        				<w2:column dataType="text" name="청구유형" id="claim_type"></w2:column>
        				<w2:column dataType="text" name="고객명" id="user_name"></w2:column>
        				<w2:column dataType="number" name="청구금액" id="amount"></w2:column>
        				<w2:column dataType="text" name="처리자" id="emp_name"></w2:column>
        				<w2:column dataType="text" name="상태" id="status"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dm_customer_info">
        			<w2:keyInfo>
        				<w2:key dataType="text" name="고객명" id="userName"></w2:key>
        				<w2:key dataType="text" name="주민번호" id="rrn"></w2:key>
        				<w2:key dataType="text" name="연락처" id="phone_number"></w2:key>
        				<w2:key dataType="text" name="사용자아이디" id="id"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection />
        	<xf:submission id="sbm_searchClaimList" action="/InsWebApp/CLAIMFullJoinListByRrn.pwkjson" method="post"
        		mediatype="application/json" ref='data:json,{"id":"dm_customer_info","key":"elData"}'
        		target='data:json,{"id":"dlt_request_list","key":"elData"}' encoding="UTF-8"
        		instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="scwin.sbm_searchClaimList_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_searchUserInfo" action="/InsWebApp/UserInfoByRrn.pwkjson" method="post" mediatype="application/json" ref='data:json,{"id":"dm_customer_info","key":"elData"}' target=''
        		encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit=""
        		ev:submitdone="scwin.sbm_searchUserInfo_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        <script lazy="false" type="text/javascript"><![CDATA[// 데이터 초기화 함수를 맨 위로 이동
scwin.clearData = function() {
    search_input_front.setValue("");
    search_input_back.setValue("");
    dm_customer_info.setEmptyValue();
    dlt_request_list.removeAll();
};

scwin.onpageload = function() {
    console.log("=== 페이지 로드 시 컴포넌트 확인 ===");
    console.log("search_input_front:", typeof search_input_front);
    console.log("dm_customer_info:", typeof dm_customer_info);
    console.log("dlt_request_list:", typeof dlt_request_list);
    
    // 초기화
    scwin.clearData();
};

// 조회 버튼 클릭
scwin.btn_search_onclick = function() {
    var frontPart = search_input_front.getValue();
    var backPart = search_input_back.getValue();
    
    if (!frontPart || frontPart.trim() === "") {
        alert("주민번호 앞자리를 입력해주세요.");
        search_input_front.focus();
        return;
    }
    
    if (!backPart || backPart.trim() === "") {
        alert("주민번호 뒷자리를 입력해주세요.");
        search_input_back.focus();
        return;
    }
    
    var residentNo = frontPart.trim() + "-" + backPart.trim();
    
    // DataMap에 검색 조건 설정
    dm_customer_info.set("rrn", residentNo);
    
  
    // 전송 데이터 확인
    console.log("전송할 데이터:", dm_customer_info.getJSON());

    // 사용자 정보 조회
    $c.sbm.execute($p, sbm_searchUserInfo);
};

// 사용자 정보 조회 완료 후
scwin.sbm_searchUserInfo_submitdone = function(e) {
    console.log("=== 사용자 정보 조회 응답 ===");
    console.log("전체 응답:", e.responseJSON);
    
    var elData = e.responseJSON.elData;
    var elHeader = e.responseJSON.elHeader;

    if(elHeader == null || elHeader == "" || elHeader == "undefined" || elHeader.resSuc == false) {
        $c.win.alert(`에러코드 : ${elHeader.resCode}\n에러메시지 : ${elHeader.resMsg}`);
        return false;
    }
    
    if(elData && elData.id) {
        // 사용자 정보 표시
        dm_customer_info.setJSON(elData);
        
        // ID를 청구조회용으로 설정 (추가!)
        dm_customer_info.set("id", elData.id);
        
        console.log("User ID 설정:", elData.id);
        console.log("설정 후 DataMap:", dm_customer_info.getJSON());
        
        // 2. 청구목록 조회
        $c.sbm.execute($p, sbm_searchClaimList);
    } else {
        $c.win.alert("해당 주민번호로 등록된 고객이 없습니다.");
        scwin.clearData();
    }
};

// 청구목록 조회 완료 후
scwin.sbm_searchClaimList_submitdone = function(e) {
    console.log("=== 청구목록 조회 응답 ===");
    console.log("전체 응답:", e.responseJSON);
    
    // elData 대신 claimFullJoinVoList 사용
    var claimList = e.responseJSON.claimFullJoinVoList;
    var elHeader = e.responseJSON.elHeader;
    
    console.log("청구목록 데이터:", claimList);
    console.log("청구목록 길이:", claimList ? claimList.length : "null");
    
    if(elHeader == null || elHeader == "" || elHeader == "undefined" || elHeader.resSuc == false) {
        $c.win.alert(`에러코드 : ${elHeader.resCode}\n에러메시지 : ${elHeader.resMsg}`);
        return false;
    }
    
    if(claimList && claimList.length > 0) {
        // 청구목록을 DataList에 설정
        dlt_request_list.setJSON(claimList);
        console.log("청구목록 설정 완료:", claimList.length + "건");
    } else {
        dlt_request_list.removeAll();
        $c.win.alert("해당 고객의 청구 내역이 없습니다.");
    }
};

// 엔터키 이벤트 핸들러 (WebSquare 방식)
scwin.search_input_front_onkeydown = function(e) {
    if (e.keyCode === 13) { // Enter key
        search_input_back.focus();
    }
};

scwin.search_input_back_onkeydown = function(e) {
    if (e.keyCode === 13) { // Enter key
        scwin.btn_search_onclick();
    }
};
]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" class="">
    	<xf:group class="sub_contents" id="" meta_snippetCategory="00_화면시작" meta_snippetKeyComponent="true" meta_snippetName="0_01 페이지시작"
    		style="">
    		<xf:group class="pgtbox" id="" meta_snippetCategory="02_타이틀" meta_snippetKeyComponent="true" meta_snippetName="2_01 페이지타이틀"
    			style="border-bottom: .2px solid #3674B5;padding-bottom: 20px;">
    			<w2:textbox class="pgt_tit" id="" label="주민번호 조회" style="" tagname=""></w2:textbox>
    		</xf:group>
    		<xf:group style="" id="" class="search-section">
    			<w2:textbox style="" id="" label="주민번호" class="search-label"></w2:textbox>
    			<xf:group style="" id="" class="search-row">
    				<xf:input id="search_input_front" style="" class="search-input" placeholder="주민번호 앞자리를 입력하세요."
    					ev:onkeydown="scwin.search_input_front_onkeydown">
    				</xf:input>
    				<w2:textbox id="" label="-" style=""></w2:textbox>
    				<xf:input id="search_input_back" style="" class="search-input" ev:onkeydown="scwin.search_input_back_onkeydown" placeholder="주민번호 뒷자리를 입력하세요."></xf:input>
    				<w2:button style="" id="btn_search" class="search-btn" label="검색" ev:onclick="scwin.btn_search_onclick"></w2:button>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" id="" class="info-section">
    			<w2:textbox id="" label="고객 기본 정보" style="" class="info-title"></w2:textbox>
    			<xf:group style="" id="" class="info-row">
    				<xf:group style="" id="" class="info-group">
    					<w2:textbox style="" id="" label="고객명" class="info-label"></w2:textbox>
    					<w2:textbox ref="data:dm_customer_info.userName" style="" id="txt_customer_name" label="" class="info-input"></w2:textbox>
    				</xf:group>
    				<xf:group style="" id="" class="info-group">
    					<w2:textbox style="" id="" label="주민번호" class="info-label"></w2:textbox>
    					<w2:textbox ref="data:dm_customer_info.rrn" style="" id="txt_resident_no" label="" class="info-input"></w2:textbox>
    				</xf:group>
    				<xf:group style="" id="" class="info-group">
    					<w2:textbox style="" id="" label="연락처" class="info-label"></w2:textbox>
    					<w2:textbox ref="data:dm_customer_info.phone_number" style="" id="txt_contact" label="" class="info-input"></w2:textbox>
    				</xf:group>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" id="" class="">
    			<xf:group tagname="caption" text="고객 청구목록" class="results-title"></xf:group>
    			<xf:group adaptiveThreshold="" class="gvwbox" id="" meta_snippetCategory="06_그리드" meta_snippetKeyComponent="true"
    				meta_snippetName="6_01 그리드" style="">
    				<w2:gridView autoFit="allColumn" checkReadOnlyOnPasteEnable="" class="gvw" dataList="data:dlt_request_list"
    					focusMode="row" id="" scrollByColumn="false" scrollByColumnAdaptive="false" style="height: 153px;margin-top: 7px;">
    					<w2:caption id="caption3" style="" value="this is a grid caption."></w2:caption>
    					<w2:header id="header" style="" class="gvw-header">
    						<w2:row id="header-row" style="">
    							<w2:column width="70" inputType="text" style="" id="column1" value="청구번호" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="column2" value="청구유형" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="column3" value="고객명" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="column4" value="청구금액" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="column5" value="처리자" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="column7" value="상태" displayMode="label" class=""></w2:column>
    						</w2:row>
    					</w2:header>
    					<w2:gBody id="gBody" style="" class="gvw-body">
    						<w2:row id="gvw-row" style="">
    							<w2:column width="70" inputType="text" style="" id="claim_no" value="" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="claim_type" value="" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="user_name" value="" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="amount" value="" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="emp_name" value="" displayMode="label" class=""></w2:column>
    							<w2:column width="70" inputType="text" style="" id="status" value="" displayMode="label" class=""></w2:column>
    						</w2:row>
    					</w2:gBody>
    				</w2:gridView>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" id="" class="status-badge">
    			<xf:group style="" id="" text="완료" class="status-badge status-complete"></xf:group>
    			<xf:group style="" id="" text="접수" class="status-badge status-pending"></xf:group>
    			<xf:group style="" id="" text="심사 중" class="status-badge status-processing"></xf:group>
    		</xf:group>
    	</xf:group>
    </body>
</html>
