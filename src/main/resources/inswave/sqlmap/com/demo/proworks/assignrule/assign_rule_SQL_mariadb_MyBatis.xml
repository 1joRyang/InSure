<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.demo.proworks.assignrule">

	<insert id="insertAssignRule" parameterType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		INSERT INTO ASSIGN_RULE (RULE_ID, KEYWORD, DEPT)
		VALUES (#{rule_id}, #{keyword}, #{dept})
	</insert>

	<update id="updateAssignRule" parameterType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		UPDATE ASSIGN_RULE
		SET KEYWORD = #{keyword}, DEPT = #{dept}
		WHERE RULE_ID = #{rule_id}
	</update>

	<delete id="deleteAssignRule" parameterType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		DELETE FROM ASSIGN_RULE WHERE RULE_ID = #{rule_id}
	</delete>

	<select id="selectAssignRule" parameterType="com.demo.proworks.assignrule.vo.AssignRuleVo"
		resultType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		SELECT RULE_ID, KEYWORD, DEPT FROM ASSIGN_RULE WHERE RULE_ID = #{rule_id}
	</select>

	<select id="selectListAssignRule" parameterType="com.demo.proworks.assignrule.vo.AssignRuleVo"
		resultType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		SELECT RULE_ID, KEYWORD, DEPT FROM ASSIGN_RULE ORDER BY RULE_ID
	</select>

	<select id="selectListCountAssignRule" parameterType="com.demo.proworks.assignrule.vo.AssignRuleVo" resultType="long">
		SELECT COUNT(*) FROM
		ASSIGN_RULE
	</select>

	<select id="selectAssignRuleByKeyword" parameterType="string" resultType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		SELECT RULE_ID, KEYWORD, DEPT FROM ASSIGN_RULE 
		WHERE LOWER(KEYWORD) LIKE CONCAT('%', LOWER(#{keyword}), '%')
	</select>

	<select id="selectDeptIdByDeptName" parameterType="string" resultType="string">
		<!-- SELECT DEPT_ID FROM INS_DEPT WHERE DEPT_NAME = #{deptName} LIMIT 1 -->
		SELECT DEPT_ID FROM INS_DEPT
		WHERE DEPT_NAME = #{deptName}
	</select>

	<select id="selectEmployeeByDeptId" parameterType="string" resultType="int">
		SELECT EMP_NO FROM EMPLOYEE WHERE DEPT_ID = #{deptId} ORDER BY
		EMP_NO LIMIT 1
	</select>

	<update id="updateClaimAssignment" parameterType="map">
		UPDATE CLAIM SET EMP_NO = #{empNo} WHERE CLAIM_NO = #{claimNo}
	</update>

	<select id="selectUnassignedClaims" resultType="com.demo.proworks.claim.vo.ClaimVo">
		SELECT CLAIM_NO, CLAIM_TYPE, RECEIPT_DATE, STATUS, EMP_NO
		FROM CLAIM
		WHERE (EMP_NO IS NULL OR EMP_NO = '')
		ORDER BY RECEIPT_DATE DESC
	</select>
	<select id="selectAllAssignRules" resultType="com.demo.proworks.assignrule.vo.AssignRuleVo">
		SELECT RULE_ID, KEYWORD, DEPT FROM ASSIGN_RULE ORDER BY RULE_ID
	</select>

	<select id="selectEmployeesByDeptId" parameterType="string" resultType="com.demo.proworks.emp.vo.EmpVo">
		SELECT EMP_NO, EMP_NAME, STATUS, DEPT_ID, ROLE
		FROM EMPLOYEE
		WHERE DEPT_ID = #{deptId}
	</select>

	<update id="updateAutoAssignConfig" parameterType="string">
		INSERT INTO ASSIGN_RULE (RULE_ID, KEYWORD, DEPT)
		VALUES ('AUTO_ASSIGN_CONFIG',
		'AUTO_ASSIGN_ENABLED', #{autoAssignEnabled})
		ON DUPLICATE KEY UPDATE DEPT = #{autoAssignEnabled}
	</update>

	<select id="getAutoAssignConfig" resultType="string">
		SELECT DEPT FROM ASSIGN_RULE
		WHERE RULE_ID = 'AUTO_ASSIGN_CONFIG' AND KEYWORD =
		'AUTO_ASSIGN_ENABLED'
		LIMIT 1
	</select>

	<!-- üî• Ï≤≠Íµ¨ Î∞∞Ï†ï Ï†ïÎ≥¥ Ï¢ÖÌï© Ï°∞Ìöå (Ìïú Î≤àÏùò ÏøºÎ¶¨Î°ú Î™®Îì† Ï†ïÎ≥¥ ÌöçÎìù) -->
	<select id="selectClaimAssignmentInfo" parameterType="string" resultType="hashmap">
		SELECT
		c.CLAIM_NO,
		c.CLAIM_TYPE,
		c.EMP_NO as CURRENT_EMP_NO,
		ar.DEPT as ASSIGN_DEPT_NAME,
		id.DEPT_ID as TARGET_DEPT_ID
		FROM CLAIM c
		LEFT JOIN ASSIGN_RULE ar
		ON TRIM(LOWER(c.CLAIM_TYPE)) = TRIM(LOWER(ar.KEYWORD))
		LEFT JOIN INS_DEPT id
		ON TRIM(LOWER(ar.DEPT)) = TRIM(LOWER(id.DEPT_NAME))
		WHERE c.CLAIM_NO = #{claimNo}
	</select>

	<!-- üî• Î∂ÄÏÑúÎ≥Ñ Ïû¨ÏßÅÏ§ëÏù∏ ÏßÅÏõê Ïàò Ï°∞Ìöå -->
	<select id="selectDeptEmployeeCount" parameterType="string" resultType="java.lang.Integer">
		SELECT /* QueryID :
		com.demo.proworks.assignrule.selectDeptEmployeeCount */
		CAST(COUNT(*) AS SIGNED) as count
		FROM EMPLOYEE
		WHERE DEPT_ID = #{deptId}
		AND STATUS = 'Ïû¨ÏßÅÏ§ë'
	</select>

	<!-- üî• Ï≤¥Íµ¨ÏÑú Ï†ïÎ≥¥ Ï°∞Ìöå (Î∞∞Ï†ïÏö©) -->
	<select id="selectClaimForAssignment" parameterType="string" resultType="com.demo.proworks.claim.vo.ClaimVo">
		SELECT /* QueryID :
		com.demo.proworks.assignrule.selectClaimForAssignment */
		CLAIM_NO as claim_no,
		CLAIM_TYPE as claim_type,
		EMP_NO as emp_no
		FROM CLAIM
		WHERE CLAIM_NO = #{claimNo}
	</select>

</mapper>
